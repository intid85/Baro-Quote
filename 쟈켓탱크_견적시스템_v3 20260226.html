<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>쟈켓탱크 견적 시스템</title>

<!-- PWA 메타태그 -->
<meta name="application-name" content="탱크 견적">
<meta name="description" content="FNS TECH 쟈켓탱크 견적 시스템">
<meta name="theme-color" content="#2f5de8">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="탱크 견적">

<!-- PWA 아이콘 (인라인 SVG → data URI) -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232f5de8'/><text y='68' x='50' text-anchor='middle' font-size='58'>🏭</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232f5de8'/><text y='68' x='50' text-anchor='middle' font-size='58'>🏭</text></svg>">

<!-- PWA Manifest (인라인) -->
<script>
(function(){
  const manifest = {
    name: '탱크 견적 시스템',
    short_name: '탱크 견적',
    description: 'FNS TECH 쟈켓탱크 견적 시스템',
    start_url: './',
    display: 'standalone',
    background_color: '#f0f2f7',
    theme_color: '#2f5de8',
    orientation: 'any',
    icons: [
      { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232f5de8'/><text y='68' x='50' text-anchor='middle' font-size='58'>🏭</text></svg>", sizes: '192x192', type: 'image/svg+xml' },
      { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232f5de8'/><text y='68' x='50' text-anchor='middle' font-size='58'>🏭</text></svg>", sizes: '512x512', type: 'image/svg+xml' }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel = 'manifest'; link.href = url;
  document.head.appendChild(link);
})();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
:root {
  --bg:#f0f2f7;--surface:#ffffff;--surface2:#f7f8fc;--border:#e2e5f0;--border2:#d0d4e8;
  --accent:#2f5de8;--accent-light:#eef2fd;--accent2:#7c4dff;--success:#0e9f6e;
  --success-light:#e8f8f3;--warn:#f59e0b;--red:#ef4444;--red-light:#fef2f2;
  --text:#1e2340;--text2:#6b7299;--text3:#9ba3c4;
  --shadow:0 2px 12px rgba(47,93,232,0.08);--shadow-lg:0 8px 32px rgba(47,93,232,0.12);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans KR',sans-serif;min-height:100vh;font-size:14px;}
.app-shell{display:flex;min-height:100vh;}
.sidebar{width:220px;min-width:220px;background:var(--text);padding:0;display:flex;flex-direction:column;position:sticky;top:0;height:100vh;}
.sidebar-logo{padding:24px 20px 20px;border-bottom:1px solid rgba(255,255,255,0.08);}
.sidebar-logo .icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:10px;}
.sidebar-logo h1{color:#fff;font-size:15px;font-weight:700;letter-spacing:-0.3px;}
.sidebar-logo p{color:rgba(255,255,255,0.4);font-size:11px;margin-top:3px;}
.sidebar-nav{padding:16px 12px;flex:1;}
.nav-label{font-size:10px;font-weight:600;letter-spacing:1.2px;color:rgba(255,255,255,0.3);text-transform:uppercase;padding:0 8px;margin-bottom:8px;margin-top:16px;}
.nav-label:first-child{margin-top:0;}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 8px;border-radius:8px;color:rgba(255,255,255,0.55);cursor:pointer;font-size:13px;font-weight:500;transition:all 0.15s;margin-bottom:2px;}
.nav-item:hover{background:rgba(255,255,255,0.08);color:#fff;}
.nav-item.active{background:var(--accent);color:#fff;}
.nav-item .nav-icon{font-size:16px;width:20px;text-align:center;}
.main{flex:1;overflow-y:auto;}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;box-shadow:var(--shadow);}
.topbar h2{font-size:17px;font-weight:700;}
.topbar-right{display:flex;align-items:center;gap:12px;}
.summary-chip{display:flex;align-items:center;gap:8px;background:var(--accent-light);border:1px solid rgba(47,93,232,0.2);border-radius:10px;padding:8px 14px;}
.summary-chip .label{font-size:11px;color:var(--accent);font-weight:500;}
.summary-chip .val{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600;color:var(--accent);}
.page{display:none;padding:28px 32px;}
.page.active{display:block;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);margin-bottom:20px;overflow:hidden;}
.card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.card-header h3{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px;}
.card-header .badge{font-size:11px;padding:2px 8px;border-radius:20px;background:var(--accent-light);color:var(--accent);font-weight:500;}
.card-body{padding:20px;}
.input-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.input-group{display:flex;flex-direction:column;gap:5px;}
.input-group label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;}
.input-group input,.input-group select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;width:100%;transition:border-color 0.15s;}
.input-group input:focus,.input-group select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(47,93,232,0.1);}
.input-group .unit{font-size:11px;color:var(--text3);margin-top:2px;}
/* 금액 콤마 미리보기 */
.money-preview{font-size:12px;font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--accent);margin-top:3px;min-height:16px;letter-spacing:-0.3px;}
.money-preview.zero{color:var(--text3);font-weight:400;}
.section-label{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text2);margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--border);display:flex;align-items:center;gap:8px;}
.section-label .dot{width:8px;height:8px;border-radius:2px;}
.price-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
.color-inner{background:#2f5de8;}.color-jacket{background:#e85d2f;}.color-outer{background:#2fbe6f;}
.calc-table{width:100%;border-collapse:collapse;table-layout:fixed;}
.calc-table th{background:var(--surface2);padding:9px 14px;font-size:11px;font-weight:600;color:var(--text2);text-align:right;text-transform:uppercase;border-bottom:2px solid var(--border);}
.calc-table th:first-child{text-align:left;}
.calc-table td{padding:10px 14px;font-size:13px;border-bottom:1px solid var(--border);text-align:right;font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.calc-table td:first-child{text-align:left;font-family:'Noto Sans KR',sans-serif;}
.calc-table tr.subtotal td{background:var(--accent-light);font-weight:700;color:var(--accent);border-bottom:2px solid var(--border2);}
.calc-table tr.total td{background:var(--text);color:#fff;font-size:15px;font-weight:700;}
.calc-table tr.total td:last-child{color:#7dd3fc;}
.search-bar{display:flex;gap:10px;margin-bottom:12px;}
.search-bar input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:11px 16px;font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;color:var(--text);transition:border-color 0.15s;}
.search-bar input:focus{border-color:var(--accent);}
.ai-results{margin-bottom:16px;}
.ai-result-header{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);margin-bottom:10px;}
.ai-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:pulse 1.4s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.7)}}
.result-chips{display:flex;flex-wrap:wrap;gap:8px;}
.result-chip{display:flex;align-items:center;gap:6px;padding:7px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;transition:all 0.15s;}
.result-chip:hover{border-color:var(--accent);background:var(--accent-light);color:var(--accent);transform:translateY(-1px);}
.result-chip .plus{color:var(--accent);font-weight:700;font-size:16px;}
.loading-msg{color:var(--text3);font-size:13px;padding:4px 0;}
.buja-table{width:100%;border-collapse:collapse;}
.buja-table th{background:var(--surface2);padding:9px 12px;font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid var(--border);text-align:left;}
.buja-table td{padding:7px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.buja-table tr:last-child td{border-bottom:none;}
.buja-table tr:hover td{background:var(--surface2);}
.tbl-input{background:transparent;border:none;outline:none;font-family:'Noto Sans KR',sans-serif;font-size:13px;color:var(--text);width:100%;padding:3px 6px;border-radius:5px;transition:background 0.12s;}
.tbl-input:focus{background:var(--accent-light);}
.tbl-num{font-family:'JetBrains Mono',monospace;font-size:13px;text-align:right;}
.del-btn{width:26px;height:26px;border-radius:6px;background:none;border:1px solid transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.12s;margin:0 auto;}
.del-btn:hover{background:var(--red-light);border-color:var(--red);color:var(--red);}
.buja-footer{padding:12px 20px;border-top:2px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface2);}
.add-row-btn{display:flex;align-items:center;gap:5px;background:none;border:1px dashed var(--border2);color:var(--text2);border-radius:7px;padding:7px 12px;cursor:pointer;font-size:12px;font-family:'Noto Sans KR',sans-serif;transition:all 0.12s;}
.add-row-btn:hover{border-color:var(--accent);color:var(--accent);}
.buja-total{font-size:13px;color:var(--text2);}
.buja-total strong{font-family:'JetBrains Mono',monospace;font-size:17px;color:var(--success);margin-left:8px;}
.empty-row td{text-align:center;padding:36px 0;color:var(--text3);font-size:13px;}
.quote-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
.summary-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;}
.summary-card .s-label{font-size:11px;color:var(--text2);margin-bottom:6px;font-weight:500;}
.summary-card .s-val{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--text);}
.summary-card.highlight{background:var(--text);border-color:var(--text);}
.summary-card.highlight .s-label{color:rgba(255,255,255,0.5);}
.summary-card.highlight .s-val{color:#7dd3fc;font-size:22px;}
.btn{padding:10px 18px;border-radius:9px;border:none;cursor:pointer;font-family:'Noto Sans KR',sans-serif;font-size:13px;font-weight:600;transition:all 0.15s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#1e4bd4;transform:translateY(-1px);}
.btn-primary:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
.btn-ghost{background:var(--surface2);border:1px solid var(--border);color:var(--text2);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
.btn-success{background:var(--success);color:#fff;padding:12px 24px;font-size:14px;}
.btn-success:hover{background:#0a7a54;transform:translateY(-1px);}
.toast{position:fixed;bottom:24px;right:24px;background:var(--text);color:#fff;border-radius:10px;padding:12px 18px;font-size:13px;font-weight:500;transform:translateY(80px);opacity:0;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);z-index:999;box-shadow:var(--shadow-lg);}
.toast.show{transform:translateY(0);opacity:1;}
.type-btn{flex:1;cursor:pointer;}
.type-btn input{display:none;}
.type-inner{border:2px solid var(--border);border-radius:12px;padding:16px 12px;text-align:center;transition:all 0.15s;background:var(--surface2);}
.type-btn input:checked+.type-inner{border-color:var(--accent);background:var(--accent-light);}
.type-icon{font-size:24px;margin-bottom:6px;}
.type-name{font-size:13px;font-weight:700;color:var(--text);}
.type-desc{font-size:11px;color:var(--text2);margin-top:2px;}
.vol-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;}
.vol-card.highlight{background:var(--success-light);border-color:#a7f3d0;}
.vol-label{font-size:11px;color:var(--text2);margin-bottom:6px;font-weight:500;}
.vol-val{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;color:var(--text);}
.vol-card.highlight .vol-val{color:var(--success);}
.vol-unit{font-size:11px;color:var(--text3);margin-top:2px;}
.drop-zone{border:2px dashed var(--border2);border-radius:14px;padding:40px 20px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--surface2);}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--accent);background:var(--accent-light);}
.drop-icon{font-size:44px;margin-bottom:12px;}
.drop-title{font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px;}
.drop-sub{font-size:12px;color:var(--text2);}
.file-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;}
.file-item .fi-icon{font-size:20px;}
.file-item .fi-name{font-size:13px;font-weight:500;flex:1;}
.file-item .fi-size{font-size:11px;color:var(--text3);}
.file-item .fi-del{cursor:pointer;color:var(--text3);font-size:16px;padding:2px 6px;border-radius:4px;}
.file-item .fi-del:hover{color:var(--red);background:var(--red-light);}
.ext-dim{background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:10px 14px;}
.ext-dim .ed-label{font-size:10px;font-weight:600;color:var(--text2);text-transform:uppercase;margin-bottom:4px;}
.ext-dim .ed-val{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;color:var(--accent);}
.ext-dim .ed-unit{font-size:11px;color:var(--text3);}
.ext-part{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;background:var(--success-light);border:1px solid #a7f3d0;font-size:12px;font-weight:500;color:var(--success);cursor:pointer;transition:all 0.12s;}
.ext-part:hover{background:var(--success);color:#fff;}
.ext-part.excluded{background:var(--surface2);border-color:var(--border);color:var(--text3);text-decoration:line-through;}
.qtag{display:inline-flex;align-items:center;gap:4px;padding:5px 10px 5px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;font-size:12px;font-weight:500;color:var(--text2);transition:all 0.12s;}
.qtag:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
.qtag-del{font-size:14px;color:var(--text3);cursor:pointer;line-height:1;padding:0 2px;border-radius:50%;transition:all 0.12s;}
.qtag-del:hover{color:var(--red);background:var(--red-light);}
.qtag-add{display:inline-flex;align-items:center;padding:5px 12px;background:none;border:1px dashed var(--border2);border-radius:20px;font-size:12px;font-weight:600;color:var(--accent);cursor:pointer;transition:all 0.12s;}
.qtag-add:hover{background:var(--accent-light);border-color:var(--accent);}

/* preset-chip */
.preset-chip{display:inline-flex;align-items:center;gap:6px;padding:5px 8px 5px 11px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;cursor:pointer;font-size:12px;font-weight:500;color:var(--text);transition:all 0.15s;user-select:none;}
.preset-chip:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
.preset-chip.preset-on{background:var(--success-light);border-color:var(--success);color:var(--success);}
.preset-check{font-size:13px;font-weight:700;flex-shrink:0;}
.preset-name{flex:1;}
/* 단가 입력칸 */
.preset-price-wrap{display:inline-flex;align-items:center;gap:2px;background:rgba(0,0,0,0.04);border-radius:6px;padding:2px 6px;margin-left:2px;cursor:default;}
.preset-chip:hover .preset-price-wrap{background:rgba(47,93,232,0.08);}
.preset-chip.preset-on .preset-price-wrap{background:rgba(14,159,110,0.12);}
.preset-price-input{width:72px;border:none;background:transparent;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--text2);text-align:right;outline:none;cursor:text;}
.preset-chip.preset-on .preset-price-input{color:var(--success);}
.preset-price-input:focus{color:var(--accent);}
.preset-price-unit{font-size:10px;color:var(--text3);flex-shrink:0;}
.preset-del{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;font-size:11px;color:var(--text3);cursor:pointer;border-radius:50%;line-height:1;transition:all 0.12s;flex-shrink:0;margin-left:2px;}
.preset-del:hover{color:var(--red) !important;background:var(--red-light);}
/* 저장 상태 표시 */
.save-indicator{font-size:11px;color:var(--success);padding:2px 8px;border-radius:20px;background:var(--success-light);display:none;}
.save-indicator.show{display:inline-block;}

/* 콤마 포맷 입력 래퍼 */
.money-wrap{position:relative;display:flex;align-items:center;}
.money-wrap input{padding-right:28px !important;}
.money-display{position:absolute;right:10px;font-size:10px;color:var(--text3);pointer-events:none;white-space:nowrap;font-family:'JetBrains Mono',monospace;}
/* 단가 전용 입력 - 콤마 미리보기 */
.money-preview{font-size:12px;color:var(--accent);font-family:'JetBrains Mono',monospace;margin-top:3px;font-weight:600;min-height:15px;}
/* 부자재 단가 입력 - 인라인 콤마 힌트 */
.price-inp-wrap{position:relative;display:flex;flex-direction:column;gap:2px;}
.price-hint{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text3);min-height:13px;text-align:right;padding-right:2px;}
.cat-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.cat-title-wrap{display:flex;align-items:center;gap:6px;}
.cat-title{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.8px;cursor:pointer;padding:2px 4px;border-radius:4px;transition:all 0.12s;}
.cat-title:hover{background:var(--accent-light);color:var(--accent);}
.cat-title-input{font-size:11px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:0.8px;background:var(--accent-light);border:1px solid var(--accent);border-radius:4px;padding:2px 6px;outline:none;width:120px;}
.cat-actions{display:flex;align-items:center;gap:4px;}
.cat-del-btn{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:4px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;transition:all 0.12s;}
.cat-del-btn:hover{color:var(--red);background:var(--red-light);}
/* 카테고리 추가 버튼 */
.add-cat-btn{display:flex;align-items:center;gap:6px;padding:10px 16px;background:none;border:2px dashed var(--border2);border-radius:10px;color:var(--text2);cursor:pointer;font-size:13px;font-family:'Noto Sans KR',sans-serif;font-weight:500;width:100%;margin-top:4px;transition:all 0.15s;}
.add-cat-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
/* 시세 기록 */
.price-hist-row{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;flex-wrap:wrap;}
.price-hist-date{font-size:12px;font-weight:600;color:var(--text2);min-width:90px;flex-shrink:0;}
.price-hist-vals{display:flex;gap:6px;flex:1;}
.price-hist-chip{font-size:12px;font-family:'JetBrains Mono',monospace;font-weight:600;padding:3px 8px;background:var(--accent-light);color:var(--accent);border-radius:6px;}
.price-hist-chip.s316{background:#f3e8ff;color:#7c4dff;}
.price-hist-memo{font-size:11px;color:var(--text3);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.price-hist-apply{padding:4px 10px;border-radius:6px;border:1px solid var(--accent);background:none;color:var(--accent);font-size:11px;font-weight:600;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:all 0.12s;flex-shrink:0;}
.price-hist-apply:hover{background:var(--accent);color:#fff;}
.price-hist-del{width:22px;height:22px;border-radius:5px;border:1px solid var(--border);background:none;color:var(--text3);font-size:12px;cursor:pointer;transition:all 0.12s;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.price-hist-del:hover{border-color:var(--red);color:var(--red);background:var(--red-light);}

.vendor-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:10px;position:relative;transition:all 0.15s;}
.vendor-card:hover{border-color:var(--accent);box-shadow:var(--shadow);}
.vendor-top{display:flex;align-items:flex-start;gap:10px;}
.vendor-emoji{font-size:28px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--surface);border:1px solid var(--border);border-radius:10px;flex-shrink:0;}
.vendor-info{flex:1;min-width:0;}
.vendor-name{font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.vendor-category{font-size:11px;color:var(--text2);line-height:1.5;}
.vendor-actions{display:flex;gap:6px;align-items:center;}
.vendor-link{flex:1;display:flex;align-items:center;justify-content:center;gap:5px;padding:8px 0;background:var(--accent);color:#fff;border-radius:8px;font-size:12px;font-weight:600;text-decoration:none;transition:all 0.15s;}
.vendor-link:hover{background:#1e4bd4;transform:translateY(-1px);}
.vendor-del{width:28px;height:28px;border-radius:7px;background:none;border:1px solid var(--border);color:var(--text3);cursor:pointer;font-size:14px;transition:all 0.12s;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.vendor-del:hover{background:var(--red-light);border-color:var(--red);color:var(--red);}
/* 추가 모달 */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px);}
.modal-box{background:var(--surface);border-radius:16px;padding:28px;width:360px;box-shadow:var(--shadow-lg);display:flex;flex-direction:column;gap:16px;}
.modal-title{font-size:16px;font-weight:700;}
.modal-field{display:flex;flex-direction:column;gap:5px;}
.modal-field label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;}
.modal-field input{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;color:var(--text);transition:border-color 0.15s;}
.modal-field input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(47,93,232,0.1);}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:4px;}
.preset-drag-handle{font-size:13px;color:var(--text3);cursor:grab;padding:0 2px;line-height:1;user-select:none;}
.preset-drag-handle:active{cursor:grabbing;}
.preset-drag-ghost{opacity:0.4;background:var(--accent-light)!important;border:1.5px dashed var(--accent)!important;}
.preset-drag-chosen{box-shadow:0 4px 16px rgba(0,0,0,0.18);transform:scale(1.04);}
.preset-chip-wrap{min-height:32px;border-radius:8px;transition:background 0.15s;}
.preset-chip-wrap.sortable-over{background:var(--accent-light);}
.preset-edit{font-size:11px;color:var(--text3);cursor:pointer;padding:0 2px;border-radius:3px;transition:color 0.15s;line-height:1;}
.preset-edit:hover{color:var(--accent);}
.vendor-edit{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:13px;color:var(--text2);transition:all 0.15s;}
.vendor-edit:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
.nav-drag-handle{font-size:13px;color:var(--text3);cursor:grab;padding:0 4px 0 0;opacity:0;transition:opacity 0.15s;user-select:none;flex-shrink:0;}
.nav-item:hover .nav-drag-handle{opacity:1;}
.nav-drag-handle:active{cursor:grabbing;}
.nav-drag-ghost{opacity:0.35;background:var(--accent-light)!important;}
.nav-drag-chosen{background:var(--surface2)!important;box-shadow:0 2px 12px rgba(0,0,0,0.18);}
.nav-label-text{flex:1;cursor:default;}
.nav-label-text:hover{text-decoration:underline dotted var(--text3);}

/* 도장 업로드 */
.stamp-drop{width:160px;height:110px;border:2px dashed var(--border2);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.15s;background:var(--surface2);}
.stamp-drop:hover,.stamp-drop.dragover{border-color:var(--accent);background:var(--accent-light);}

/* ══ 모바일 반응형 ══ */
@media (max-width: 768px) {
  .app-shell { flex-direction: column; }

  /* 사이드바 → 하단 탭바 */
  .sidebar {
    width: 100% !important;
    height: auto !important;
    flex-direction: row !important;
    padding: 0 !important;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 100;
    border-radius: 0 !important;
    box-shadow: 0 -2px 16px rgba(0,0,0,0.15);
    overflow-x: auto;
    overflow-y: hidden;
  }
  .sidebar-logo { display: none !important; }
  .sidebar-nav {
    display: flex !important;
    flex-direction: row !important;
    padding: 0 !important;
    width: 100%;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .sidebar-nav::-webkit-scrollbar { display: none; }
  .nav-label { display: none !important; }
  .nav-item {
    flex-direction: column !important;
    gap: 2px !important;
    padding: 8px 12px !important;
    border-radius: 0 !important;
    min-width: 64px;
    text-align: center;
    font-size: 10px !important;
    white-space: nowrap;
    flex-shrink: 0;
    margin-bottom: 0 !important;
    border-bottom: 3px solid transparent;
  }
  .nav-item.active {
    border-bottom: 3px solid #fff !important;
    background: rgba(255,255,255,0.12) !important;
  }
  .nav-icon { font-size: 20px !important; }
  .nav-drag-handle { display: none !important; }
  .nav-label-text { font-size: 10px !important; }

  /* 메인 영역 */
  .main {
    margin-left: 0 !important;
    padding-bottom: 80px !important; /* 탭바 높이만큼 */
  }
  .topbar {
    padding: 12px 16px !important;
    position: sticky;
    top: 0;
    z-index: 50;
  }
  .topbar h2 { font-size: 15px !important; }
  .topbar-right { gap: 8px !important; }
  .summary-chip { font-size: 11px !important; padding: 4px 10px !important; }

  /* 카드/그리드 */
  .page { padding: 12px !important; }
  .card { border-radius: 10px !important; margin-bottom: 12px !important; }
  .input-grid { grid-template-columns: 1fr !important; }
  .input-grid [style*="grid-column:1/-1"] { grid-column: 1 !important; }

  /* 테이블 가로 스크롤 */
  .calc-table { font-size: 11px !important; }
  .card-body { overflow-x: auto; }

  /* 버튼 */
  .btn { padding: 10px 14px !important; font-size: 12px !important; }

  /* PDF 모달 */
  #pdfModal > div > div { border-radius: 12px 12px 0 0 !important; position: fixed !important; bottom: 0; left: 0; right: 0; top: auto !important; max-height: 90vh; }
}

</style>
</head>
<body>
<div class="app-shell">
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="icon">🏭</div>
    <h1>탱크 견적 시스템</h1>
    <p>FNS TECH</p>
  </div>
  <nav class="sidebar-nav" id="sidebarNav">
    <!-- JS로 렌더링 -->
  </nav>
</aside>
<div class="main">
  <div class="topbar">
    <h2 id="topbarTitle">도면 업로드</h2>
    <div class="topbar-right">
      <div class="summary-chip">
        <span class="label">견적 총액</span>
        <span class="val" id="topTotal">0 원</span>
      </div>
      <button class="btn btn-success" onclick="exportExcel()">📥 엑셀 저장</button>
    </div>
  </div>

  <!-- PAGE 0: 도면 업로드 -->
  <div class="page active" id="page-pdf">
    <div class="card">
      <div class="card-header"><h3>📄 도면 PDF 업로드</h3><span class="badge">AI 자동 추출</span></div>
      <div class="card-body">
        <div id="dropZone" class="drop-zone" onclick="document.getElementById('pdfFileInput').click()">
          <div class="drop-icon">📂</div>
          <div class="drop-title">PDF 파일을 여기에 끌어다 놓거나 클릭하세요</div>
          <div class="drop-sub">캐드 도면, 스펙시트 등 — 여러 장 동시 업로드 가능</div>
          <input type="file" id="pdfFileInput" accept=".pdf" multiple style="display:none" onchange="onFileSelect(event)">
        </div>
        <div id="fileList" style="display:none;margin-top:16px">
          <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px">업로드된 파일</div>
          <div id="fileItems" style="display:flex;flex-direction:column;gap:6px"></div>
        </div>
        <div id="analyzeWrap" style="display:none;margin-top:16px;text-align:center">
          <button class="btn btn-primary" style="padding:13px 32px;font-size:15px" onclick="analyzePDFs()">🤖 AI로 도면 분석하기</button>
        </div>
      </div>
    </div>
    <div class="card" id="analysisCard" style="display:none">
      <div class="card-header"><h3>🔍 분석 결과</h3></div>
      <div class="card-body">
        <div id="analysisLoading" style="text-align:center;padding:30px 0">
          <div style="font-size:36px;margin-bottom:12px">🤖</div>
          <div style="font-size:14px;font-weight:600;color:var(--text2)" id="loadingMsg">도면을 분석하고 있어요...</div>
          <div style="margin-top:12px;height:4px;background:var(--border);border-radius:4px;overflow:hidden">
            <div id="progressBar" style="height:100%;background:var(--accent);border-radius:4px;width:0%;transition:width 0.4s"></div>
          </div>
        </div>
        <div id="analysisResult" style="display:none">
          <div style="margin-bottom:20px">
            <div class="section-label"><span class="dot color-inner"></span>추출된 치수</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px" id="extractedDims"></div>
          </div>
          <div style="margin-bottom:20px">
            <div class="section-label"><span class="dot color-jacket"></span>추출된 부품/노즐</div>
            <div id="extractedParts" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          </div>
          <div id="analysisNote" style="font-size:12px;color:var(--text2);background:var(--surface2);border-radius:8px;padding:12px 16px;line-height:1.8;margin-bottom:16px"></div>
          <div style="display:flex;gap:10px;justify-content:center">
            <button class="btn btn-primary" style="padding:12px 28px;font-size:14px" onclick="applyAnalysis()">✅ 치수 & 부품 모두 적용</button>
            <button class="btn btn-ghost" onclick="goPage('page-dim')">치수만 보기 →</button>
          </div>
        </div>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:4px">
      <button class="btn btn-ghost" onclick="goPage('page-vol')">수동 입력으로 →</button>
    </div>
  </div>

  <!-- PAGE 1: 용량 계산 -->
  <div class="page" id="page-vol">
    <div class="card">
      <div class="card-header"><h3>🧮 탱크 용량 계산</h3><span class="badge">내통 기준</span></div>
      <div class="card-body">
        <div style="margin-bottom:20px">
          <div style="font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">하부 타입 선택</div>
          <div style="display:flex;gap:10px">
            <label class="type-btn"><input type="radio" name="bottomType" value="dish" checked onchange="onTypeChange()"><div class="type-inner"><div class="type-icon">⌣</div><div class="type-name">10%경판</div><div class="type-desc">접시형 (일반)</div></div></label>
            <label class="type-btn"><input type="radio" name="bottomType" value="flat" onchange="onTypeChange()"><div class="type-inner"><div class="type-icon">▬</div><div class="type-name">평경판</div><div class="type-desc">바닥 평평</div></div></label>
            <label class="type-btn"><input type="radio" name="bottomType" value="cone" onchange="onTypeChange()"><div class="type-inner"><div class="type-icon">▽</div><div class="type-name">콘타입</div><div class="type-desc">원뿔형 하부</div></div></label>
          </div>
        </div>
        <div class="input-grid" style="margin-bottom:20px">
          <div class="input-group"><label>내경 ID (mm)</label><input type="number" id="v_id" value="1000" oninput="calcVol()"></div>
          <div class="input-group"><label>직선부 높이 H (mm)</label><input type="number" id="v_h" value="1000" oninput="calcVol()"></div>
          <div class="input-group" id="cone-angle-group" style="display:none"><label>콘 각도 (°)</label><select id="v_cone_angle" onchange="calcVol()"><option value="60">60°</option><option value="90" selected>90°</option><option value="120">120°</option></select></div>
        </div>
        <div id="volResult" style="display:none">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
            <div class="vol-card" style="border-left:3px solid var(--accent)"><div class="vol-label">동체 용량</div><div class="vol-val" id="vol_body">0</div><div class="vol-unit">리터</div></div>
            <div class="vol-card" style="border-left:3px solid #e85d2f"><div class="vol-label">상·하부 용량</div><div class="vol-val" id="vol_heads">0</div><div class="vol-unit">리터</div></div>
            <div class="vol-card highlight" style="border-left:3px solid var(--success)"><div class="vol-label">총 용량</div><div class="vol-val" id="vol_total">0</div><div class="vol-unit">리터</div></div>
          </div>
          <div id="volFormula" style="font-size:12px;color:var(--text2);background:var(--surface2);border-radius:8px;padding:12px 16px;line-height:1.8"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h3>🔄 용량으로 치수 추천</h3><span class="badge">역산</span></div>
      <div class="card-body">
        <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:16px">
          <div class="input-group" style="flex:1"><label>목표 용량 (리터)</label><input type="number" id="target_vol" value="350" oninput="calcReverse()"></div>
          <div class="input-group" style="flex:1"><label>하부 타입</label><select id="rev_bottom" onchange="calcReverse()"><option value="dish">10%경판</option><option value="flat">평경판</option><option value="cone">콘타입 (90°)</option></select></div>
          <div class="input-group" style="flex:1"><label>높이/내경 비율</label><select id="rev_ratio" onchange="calcReverse()"><option value="0.8">0.8 (납작)</option><option value="1.0" selected>1.0 (정비례)</option><option value="1.2">1.2 (보통)</option><option value="1.5">1.5 (슬림)</option><option value="2.0">2.0 (높은형)</option></select></div>
        </div>
        <div id="revResult" style="display:none">
          <table class="calc-table">
            <thead><tr><th>내경 (mm)</th><th>직선부 높이 (mm)</th><th>하부 타입</th><th>계산 용량 (L)</th><th>오차</th><th></th></tr></thead>
            <tbody id="revBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end">
      <button class="btn btn-primary" onclick="goPage('page-dim')">다음: 치수 입력 →</button>
    </div>
  </div>

  <!-- PAGE 2: 치수 입력 -->
  <div class="page" id="page-dim">
    <div class="card">
      <div class="card-header"><h3>💰 재질 단가</h3><span class="badge">원/kg</span></div>
      <div class="card-body">
        <!-- 시세 변동 기록 (위) -->
        <div style="margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border)">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
            <span style="font-size:12px;font-weight:700;color:var(--text2);letter-spacing:0.5px">📅 시세 변동 기록</span>
            <button class="btn btn-ghost" style="font-size:11px;padding:4px 10px" onclick="saveMarketPrice()">현재 단가 저장</button>
          </div>
          <div id="priceHistoryList" style="display:flex;flex-direction:column;gap:6px;max-height:200px;overflow-y:auto"></div>
          <div id="priceHistoryEmpty" style="font-size:12px;color:var(--text3);text-align:center;padding:14px 0">저장된 시세 기록이 없어요</div>
        </div>
        <!-- 단가 입력 -->
        <div class="price-row">
          <div class="input-group">
            <label>SUS304 단가 (1D)</label>
            <input type="number" id="price304" value="4000" oninput="calcAll();updatePreview('price304','prev304','원/kg')">
            <span class="money-preview" id="prev304">4,000 원/kg</span>
          </div>
          <div class="input-group">
            <label>SUS316L 단가 (1D)</label>
            <input type="number" id="price316" value="4800" oninput="calcAll();updatePreview('price316','prev316','원/kg')">
            <span class="money-preview" id="prev316">4,800 원/kg</span>
          </div>
        </div>
      </div>
    </div>
    <div class="card" id="card-inner">
      <div class="card-header">
        <h3><span class="dot color-inner" style="width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:6px;"></span>내통</h3>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text2)">
          <input type="checkbox" id="use_inner" checked onchange="togglePart('inner')" style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer">
          사용
        </label>
      </div>
      <div class="card-body" id="body-inner">
        <div class="input-grid">
          <div class="input-group"><label>내경 ID (mm)</label><input type="number" id="i_id" value="1120" oninput="calcAll()"></div>
          <div class="input-group"><label>높이 H (mm)</label><input type="number" id="i_h" value="1000" oninput="calcAll()"></div>
          <div class="input-group"><label>동체 두께 T (mm)</label><input type="number" id="i_t" value="6" oninput="calcAll()"></div>
          <div class="input-group"><label>재질</label><select id="i_mat" onchange="calcAll()"><option value="304">SUS304</option><option value="316">SUS316L</option></select></div>
        </div>
        <input type="hidden" id="i_pt" value="6">
      </div>
    </div>
    <div class="card" id="card-jacket">
      <div class="card-header">
        <h3><span class="dot color-jacket" style="width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:6px;"></span>쟈켓</h3>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text2)">
          <input type="checkbox" id="use_jacket" checked onchange="togglePart('jacket')" style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer">
          사용
        </label>
      </div>
      <div class="card-body" id="body-jacket">
        <div class="input-grid">
          <div class="input-group"><label>내경 ID (mm)</label><input type="number" id="j_id" value="1222" oninput="calcAll()"></div>
          <div class="input-group"><label>높이 H (mm)</label><input type="number" id="j_h" value="500" oninput="calcAll()"></div>
          <div class="input-group"><label>두께 T (mm)</label><input type="number" id="j_t" value="4" oninput="calcAll()"></div>
          <div class="input-group"><label>재질</label><select id="j_mat" onchange="calcAll()"><option value="304">SUS304</option><option value="316">SUS316L</option></select></div>
        </div>
      </div>
    </div>
    <div class="card" id="card-outer">
      <div class="card-header">
        <h3><span class="dot color-outer" style="width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:6px;"></span>외통</h3>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;font-weight:500;color:var(--text2)">
          <input type="checkbox" id="use_outer" checked onchange="togglePart('outer')" style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer">
          사용
        </label>
      </div>
      <div class="card-body" id="body-outer">
        <div class="input-grid">
          <div class="input-group"><label>내경 ID (mm)</label><input type="number" id="o_id" value="1324" oninput="calcAll()"></div>
          <div class="input-group"><label>높이 H (mm)</label><input type="number" id="o_h" value="1000" oninput="calcAll()"></div>
          <div class="input-group"><label>두께 T (mm)</label><input type="number" id="o_t" value="3" oninput="calcAll()"></div>
          <div class="input-group"><label>재질</label><select id="o_mat" onchange="calcAll()"><option value="304">SUS304</option><option value="316">SUS316L</option></select></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h3>📊 자재비 계산 결과</h3></div>
      <div class="card-body" style="padding:0">
        <table class="calc-table">
          <colgroup>
            <col style="width:20%"><col style="width:18%"><col style="width:18%"><col style="width:18%"><col style="width:26%">
          </colgroup>
          <thead><tr><th>구분</th><th>경판 KG</th><th>동체 KG</th><th>총 KG</th><th>금액</th></tr></thead>
          <tbody id="calcBody"></tbody>
        </table>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:4px;">
      <button class="btn btn-ghost" onclick="goPage('page-vol')">← 용량 계산</button>
      <button class="btn btn-primary" onclick="goPage('page-buja')">다음: 부자재 입력 →</button>
    </div>
  </div>

  <!-- PAGE 3: 부자재 -->
  <div class="page" id="page-buja">
    <div class="card">
      <div class="card-header"><h3>⚡ 자주 쓰는 부품</h3><span class="badge">체크하면 목록에 추가</span></div>
      <div class="card-body" style="padding:12px 16px">
        <div id="presetList"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h3>🔍 AI 부품 검색</h3></div>
      <div class="card-body">
        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="예) 맨홀, 볼밸브, 레벨게이지, 교반기..." />
          <button class="btn btn-primary" id="searchBtn" onclick="doSearch()">검색</button>
        </div>
        <div style="display:flex;align-items:center;flex-wrap:wrap;gap:6px;margin-bottom:14px" id="quickTagWrap"></div>
        <div class="ai-results" id="aiResults" style="display:none">
          <div class="ai-result-header"><div class="ai-dot"></div><span id="aiLabel">검색 결과</span></div>
          <div class="result-chips" id="resultChips"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3>🔩 부자재 목록</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="bujaCount" style="font-size:12px;color:var(--text2)">0개</span>
          <button class="btn btn-ghost" style="padding:6px 12px;font-size:12px" onclick="clearBuja()">전체삭제</button>
        </div>
      </div>
      <table class="buja-table">
        <thead><tr><th style="width:36px">#</th><th>항목명</th><th style="width:80px;text-align:right">수량</th><th style="width:130px;text-align:right">단가 (원)</th><th style="width:130px;text-align:right">금액 (원)</th><th style="width:44px;text-align:center">삭제</th></tr></thead>
        <tbody id="bujaBody"></tbody>
      </table>
      <div class="buja-footer">
        <button class="add-row-btn" onclick="addBuja('')">＋ 직접 추가</button>
        <div class="buja-total">부자재 합계 <strong id="bujaTotal">0 원</strong></div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;gap:10px;margin-top:4px;">
      <button class="btn btn-ghost" onclick="goPage('page-dim')">← 치수 입력</button>
      <button class="btn btn-primary" onclick="goPage('page-extra')">다음: 기타비용 →</button>
    </div>
  </div>

  <!-- PAGE 4: 기타비용 -->
  <div class="page" id="page-extra">
    <div class="card">
      <div class="card-header">
        <h3>🔧 기타 비용</h3>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 14px" onclick="addExtraItem()">＋ 항목 추가</button>
      </div>
      <table class="buja-table">
        <thead>
          <tr>
            <th style="width:36px">#</th>
            <th>항목명</th>
            <th style="width:90px;text-align:right">수량</th>
            <th style="width:80px;text-align:center">단위</th>
            <th style="width:140px;text-align:right">단가 (원)</th>
            <th style="width:140px;text-align:right">금액 (원)</th>
            <th style="width:44px;text-align:center">삭제</th>
          </tr>
        </thead>
        <tbody id="extraBody"></tbody>
      </table>
      <div class="buja-footer">
        <div></div>
        <div class="buja-total">기타비용 합계 <strong id="extraTotal">0 원</strong></div>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;gap:10px;margin-top:4px;">
      <button class="btn btn-ghost" onclick="goPage('page-buja')">← 부자재</button>
      <button class="btn btn-primary" onclick="goPage('page-quote')">견적서 보기 →</button>
    </div>
  </div>
  <div class="page" id="page-quote">
    <div class="quote-summary">
      <div class="summary-card"><div class="s-label">자재비 합계</div><div class="s-val" id="q_mat">0</div></div>
      <div class="summary-card"><div class="s-label">부자재 합계</div><div class="s-val" id="q_buja">0</div></div>
      <div class="summary-card highlight"><div class="s-label">견적 총액</div><div class="s-val" id="q_total">0</div></div>
    </div>
    <div class="card">
      <div class="card-header"><h3>📋 견적 내역</h3></div>
      <div class="card-body" style="padding:0">
        <table class="calc-table">
          <colgroup><col style="width:25%"><col style="width:45%"><col style="width:30%"></colgroup>
          <thead><tr><th>항목</th><th>내용</th><th>금액</th></tr></thead>
          <tbody id="quoteBody"></tbody>
        </table>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;">
      <button class="btn btn-ghost" onclick="goPage('page-extra')">← 기타비용</button>
      <div style="display:flex;gap:10px">
        <button class="btn btn-ghost" style="padding:13px 22px;font-size:14px" onclick="openPdfPreview()">👁️ PDF 미리보기</button>
        <button class="btn btn-success" style="padding:13px 28px;font-size:15px" onclick="exportExcel()">📥 엑셀로 저장</button>
      </div>
    </div>
  </div>

  <!-- PAGE 5: 구매처 -->
  <div class="page" id="page-vendor">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div>
        <div style="font-size:20px;font-weight:700;margin-bottom:4px">🛒 부품 구매처</div>
        <div style="font-size:13px;color:var(--text2)">자주 사용하는 공급업체 사이트를 모아두세요</div>
      </div>
      <button class="btn btn-primary" onclick="openAddVendor()">＋ 사이트 추가</button>
    </div>
    <div id="vendorGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px"></div>
  </div>

  <!-- PAGE 6: 견적서 정보 설정 -->
  <div class="page" id="page-settings-company">
    <!-- 회사 정보 카드 -->
    <div class="card">
      <div class="card-header">
        <h3>🏢 회사 정보</h3>
        <span class="badge">견적서에 자동 반영</span>
      </div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
          <div class="input-group" style="grid-column:1/-1">
            <label>회사명</label>
            <input type="text" id="co_name" placeholder="예) FNS TECH" oninput="saveCompanyInfo()">
          </div>
          <div class="input-group">
            <label>대표자명</label>
            <input type="text" id="co_ceo" placeholder="예) 홍길동" oninput="saveCompanyInfo()">
          </div>
          <div class="input-group">
            <label>사업자등록번호</label>
            <input type="text" id="co_biz" placeholder="예) 123-45-67890" oninput="saveCompanyInfo()">
          </div>
          <div class="input-group">
            <label>전화번호</label>
            <input type="text" id="co_tel" placeholder="예) 031-000-0000" oninput="saveCompanyInfo()">
          </div>
          <div class="input-group">
            <label>이메일</label>
            <input type="text" id="co_email" placeholder="예) info@fnstech.co.kr" oninput="saveCompanyInfo()">
          </div>
          <div class="input-group" style="grid-column:1/-1">
            <label>주소</label>
            <input type="text" id="co_addr" placeholder="예) 경기도 평택시 ..." oninput="saveCompanyInfo()">
          </div>
        </div>
        <!-- 계좌 정보 -->
        <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:16px">
          <div style="font-size:12px;font-weight:700;color:var(--text2);letter-spacing:0.5px;margin-bottom:12px">💳 입금 계좌</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div class="input-group">
              <label>은행명</label>
              <input type="text" id="co_bank" placeholder="예) 국민은행" oninput="saveCompanyInfo()">
            </div>
            <div class="input-group">
              <label>예금주</label>
              <input type="text" id="co_depositor" placeholder="예) FNS TECH" oninput="saveCompanyInfo()">
            </div>
            <div class="input-group" style="grid-column:1/-1">
              <label>계좌번호</label>
              <input type="text" id="co_account" placeholder="예) 123-456-789012" oninput="saveCompanyInfo()">
            </div>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:20px">
          <div style="font-size:12px;font-weight:700;color:var(--text2);letter-spacing:0.5px;margin-bottom:12px">🔏 회사 도장</div>
          <div style="display:flex;align-items:flex-start;gap:20px;flex-wrap:wrap">
            <div id="stampDropZone" class="stamp-drop"
              onclick="document.getElementById('stampFileInput').click()"
              ondragover="event.preventDefault();this.classList.add('dragover')"
              ondragleave="this.classList.remove('dragover')"
              ondrop="handleStampDrop(event)">
              <div style="font-size:28px;margin-bottom:6px">📂</div>
              <div style="font-size:12px;font-weight:600;color:var(--text2)">도장 이미지 업로드</div>
              <div style="font-size:11px;color:var(--text3);margin-top:4px">PNG / JPG · 클릭 또는 드래그</div>
              <input type="file" id="stampFileInput" accept="image/*" style="display:none" onchange="handleStampFile(event)">
            </div>
            <div id="stampPreviewWrap" style="display:none;flex-direction:column;align-items:center;gap:8px">
              <div style="font-size:11px;color:var(--text2);font-weight:600">미리보기</div>
              <div style="width:100px;height:100px;border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:var(--surface2)">
                <img id="stampPreviewImg" style="max-width:96px;max-height:96px;object-fit:contain">
              </div>
              <button class="btn btn-ghost" style="font-size:11px;padding:4px 10px;color:var(--red)" onclick="removeStamp()">🗑 도장 삭제</button>
            </div>
          </div>
          <div style="font-size:11px;color:var(--text3);margin-top:10px">💡 배경이 투명한 PNG 파일을 쓰시면 견적서에 깔끔하게 나와요</div>
        </div>
      </div>
    </div>

    <!-- 견적 특이사항 카드 -->
    <div class="card">
      <div class="card-header">
        <h3>📋 견적 특이사항</h3>
        <button class="btn btn-ghost" style="font-size:12px;padding:6px 14px" onclick="addQuoteNote()">＋ 항목 추가</button>
      </div>
      <div class="card-body">
        <div style="font-size:12px;color:var(--text2);margin-bottom:14px">견적서 하단에 표시될 안내 문구예요. 납기, 계좌, 유효기간 등 자유롭게 추가하세요.</div>
        <div id="quoteNoteList" style="display:flex;flex-direction:column;gap:8px"></div>
        <div style="margin-top:16px;padding:10px 14px;background:var(--surface2);border-radius:8px;font-size:11px;color:var(--text3)">
          💡 기본 예시: 납기 — 계약 후 6주 / 입금 계좌 — 국민은행 000-0000-0000 / 견적 유효기간 — 30일
        </div>
      </div>
    </div>
  </div>

</div>
</div>
<!-- PDF 미리보기 모달 -->
<div id="pdfModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;backdrop-filter:blur(3px)">
  <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px">
    <div style="background:var(--surface);border-radius:16px;width:100%;max-width:720px;max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow-lg)">
      <!-- 모달 헤더 -->
      <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid var(--border);flex-shrink:0">
        <div style="font-size:16px;font-weight:700">📄 견적서 미리보기</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-ghost" style="font-size:13px;padding:8px 16px" onclick="emailQuote()">✉️ 이메일 발송</button>
          <button class="btn btn-primary" style="font-size:13px;padding:8px 16px" onclick="downloadPdf()">⬇️ PDF 다운로드</button>
          <button onclick="closePdfPreview()" style="width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:none;color:var(--text2);cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center">✕</button>
        </div>
      </div>
      <!-- 미리보기 영역 -->
      <div style="overflow-y:auto;flex:1;padding:24px;background:#e5e7eb;border-radius:0 0 16px 16px">
        <!-- A4 페이퍼 -->
        <div id="pdfPaper" style="background:#fff;width:100%;max-width:640px;margin:0 auto;padding:48px 52px;border-radius:4px;box-shadow:0 4px 24px rgba(0,0,0,0.15);font-family:'Noto Sans KR',sans-serif;color:#111;">
          <!-- 여기에 견적서 내용 렌더링 -->
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ══ 상태 ══
let bujaItems = [];
let idCnt = 0;
let calcResult = {};
let presetOnSet = new Set();

// ══ 기타비용 ══
const EXTRA_LS = 'fns_extra_v1';
const DEFAULT_EXTRA = [
  {id:1, name:'제작 공수', qty:36, unit:'공수', price:160000},
  {id:2, name:'버핑비',    qty:1,  unit:'식',   price:300000},
  {id:3, name:'가공비',    qty:1,  unit:'식',   price:200000},
  {id:4, name:'소모자재',  qty:1,  unit:'식',   price:80000},
];
function loadExtra(){ try{ const s=localStorage.getItem(EXTRA_LS); if(s) return JSON.parse(s); }catch(e){} return JSON.parse(JSON.stringify(DEFAULT_EXTRA)); }
function saveExtra(){ try{ localStorage.setItem(EXTRA_LS,JSON.stringify(extraItems)); }catch(e){} }
let extraItems = loadExtra();
let extraIdCnt = Math.max(0,...extraItems.map(i=>i.id));

function renderExtra(){
  const tbody = document.getElementById('extraBody'); if(!tbody) return;
  if(!extraItems.length){
    tbody.innerHTML='<tr class="empty-row"><td colspan="7">항목을 추가해 주세요</td></tr>';
    document.getElementById('extraTotal').textContent='0 원'; return;
  }
  tbody.innerHTML = extraItems.map((item,i)=>`
    <tr>
      <td style="color:var(--text3);font-size:12px;text-align:center">${i+1}</td>
      <td><input class="tbl-input" value="${esc(item.name)}" placeholder="항목명"
            onchange="updateExtra(${item.id},'name',this.value)"></td>
      <td><input class="tbl-input tbl-num" type="number" min="0" value="${item.qty}" style="width:80px"
            onchange="updateExtra(${item.id},'qty',this.value)"></td>
      <td style="text-align:center">
        <input class="tbl-input" value="${esc(item.unit)}" placeholder="공수/식/개"
          style="width:60px;text-align:center"
          onchange="updateExtra(${item.id},'unit',this.value)">
      </td>
      <td>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:1px">
          <input class="tbl-input tbl-num" type="number" min="0" value="${item.price||0}" placeholder="0"
            oninput="updateExtra(${item.id},'price',this.value);this.nextElementSibling.textContent=+this.value?fmtWon(this.value)+' 원':''">
          <span style="font-size:10px;color:var(--accent);font-family:'JetBrains Mono',monospace;font-weight:600;min-height:13px">${item.price?fmtWon(item.price)+' 원':''}</span>
        </div>
      </td>
      <td class="tbl-num" id="eamt_${item.id}">${fmt(item.qty*(item.price||0))}</td>
      <td><button class="del-btn" onclick="deleteExtra(${item.id})">✕</button></td>
    </tr>`).join('');
  const total = extraItems.reduce((s,i)=>s+i.qty*(i.price||0),0);
  document.getElementById('extraTotal').textContent = fmt(total)+' 원';
}
function updateExtra(id, field, val){
  const item = extraItems.find(i=>i.id===id); if(!item) return;
  if(field==='qty'||field==='price') item[field]=Math.round(+val)||0;
  else item[field]=val;
  const amtEl = document.getElementById('eamt_'+id);
  if(amtEl) amtEl.textContent = fmt(item.qty*(item.price||0));
  const total = extraItems.reduce((s,i)=>s+i.qty*(i.price||0),0);
  document.getElementById('extraTotal').textContent = fmt(total)+' 원';
  saveExtra(); calcAll();
}
function addExtraItem(){
  extraItems.push({id:++extraIdCnt, name:'새 항목', qty:1, unit:'식', price:0});
  saveExtra(); renderExtra(); calcAll();
  showToast('✅ 항목 추가됨');
}
function deleteExtra(id){
  extraItems = extraItems.filter(i=>i.id!==id);
  saveExtra(); renderExtra(); calcAll();
}

// ══ 사이드바 메뉴 ══
const NAV_LS = 'fns_nav_v1';
const DEFAULT_NAV = [
  {id:'page-pdf',  icon:'📄', label:'도면 업로드',  group:'메뉴'},
  {id:'page-vol',  icon:'🧮', label:'용량 계산',    group:'메뉴'},
  {id:'page-dim',  icon:'📐', label:'치수 입력',    group:'메뉴'},
  {id:'page-buja', icon:'🔩', label:'부자재 관리',  group:'메뉴'},
  {id:'page-extra',icon:'🔧', label:'기타비용',     group:'메뉴'},
  {id:'page-quote',icon:'📋', label:'견적서',       group:'메뉴'},
  {id:'page-vendor',icon:'🛒',label:'구매처',       group:'메뉴'},
  {id:'page-settings-company',icon:'📝',label:'견적서 정보',group:'설정'},
];
function loadNav(){ try{ const s=localStorage.getItem(NAV_LS); if(s){ const d=JSON.parse(s); if(d.length) return d; } }catch(e){} return JSON.parse(JSON.stringify(DEFAULT_NAV)); }
function saveNav(){ try{ localStorage.setItem(NAV_LS,JSON.stringify(navItems)); }catch(e){} }
let navItems = loadNav();
// 혹시 새 메뉴가 DEFAULT에 있는데 저장본에 없으면 추가
DEFAULT_NAV.forEach(d=>{ if(!navItems.find(n=>n.id===d.id)) navItems.push(d); });

function renderNav(){
  const nav = document.getElementById('sidebarNav'); if(!nav) return;
  // 그룹별 분리
  const groups = [...new Set(navItems.map(n=>n.group))];
  let html = '';
  groups.forEach((g,gi)=>{
    html += `<div class="nav-label"${gi>0?' style="margin-top:12px"':''}>${g}</div>`;
    navItems.filter(n=>n.group===g).forEach(n=>{
      const isActive = document.getElementById(n.id)?.classList.contains('active');
      html += `<div class="nav-item${isActive?' active':''}" id="nav-${n.id}" data-page="${n.id}">
        <span class="nav-drag-handle" title="드래그로 순서 변경">⠿</span>
        <span class="nav-icon">${n.icon}</span>
        <span class="nav-label-text" ondblclick="startEditNavLabel('${n.id}',event)">${n.label}</span>
      </div>`;
    });
  });
  nav.innerHTML = html;
  // 클릭 이벤트
  nav.querySelectorAll('.nav-item').forEach(el=>{
    el.addEventListener('click', e=>{
      if(e.target.classList.contains('nav-drag-handle')) return;
      if(e.target.classList.contains('nav-label-text') && e.detail===2) return;
      goPage(el.dataset.page);
    });
  });
  // Sortable
  if(typeof Sortable !== 'undefined'){
    Sortable.create(nav, {
      handle: '.nav-drag-handle',
      animation: 150,
      filter: '.nav-label',
      ghostClass: 'nav-drag-ghost',
      chosenClass: 'nav-drag-chosen',
      onEnd(evt){
        // DOM 순서 기준으로 navItems 재정렬
        const newOrder = [];
        nav.querySelectorAll('.nav-item[data-page]').forEach(el=>{
          const found = navItems.find(n=>n.id===el.dataset.page);
          if(found) newOrder.push(found);
        });
        navItems = newOrder;
        saveNav();
        renderNav();
      }
    });
  }
}

function startEditNavLabel(pageId, event){
  event.stopPropagation();
  const el = event.target;
  const item = navItems.find(n=>n.id===pageId); if(!item) return;
  const old = item.label;
  const input = document.createElement('input');
  input.value = old;
  input.style.cssText = 'font-size:13px;font-weight:600;background:var(--surface);border:1px solid var(--accent);border-radius:4px;padding:1px 6px;width:100%;color:var(--text);outline:none;';
  el.replaceWith(input);
  input.focus(); input.select();
  const finish = ()=>{
    const val = input.value.trim() || old;
    item.label = val;
    saveNav();
    renderNav();
    // topbar도 갱신
    const activeEl = document.querySelector('.nav-item.active');
    if(activeEl && activeEl.dataset.page === pageId)
      document.getElementById('topbarTitle').textContent = val;
  };
  input.addEventListener('blur', finish);
  input.addEventListener('keydown', e=>{
    if(e.key==='Enter') input.blur();
    if(e.key==='Escape'){ item.label=old; renderNav(); }
  });
}

function goPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const pageEl = document.getElementById(id); if(!pageEl) return;
  pageEl.classList.add('active');
  const item = navItems.find(n=>n.id===id);
  document.getElementById('topbarTitle').textContent = item ? item.label : id;
  renderNav(); // active 상태 반영
  if (id === 'page-quote') renderQuote();
  if (id === 'page-vendor') renderVendors();
  if (id === 'page-extra') renderExtra();
  if (id === 'page-settings-company') { initCompanyForm(); renderQuoteNotes(); }
}

function getPrice(matId) {
  const p304 = +document.getElementById('price304').value||0;
  const p316 = +document.getElementById('price316').value||0;
  if(matId==='316') return p316;
  return p304; // 기본 304
}
function v(id){return +document.getElementById(id).value||0;}
// 파트 사용여부 토글
function togglePart(part) {
  const nameMap = {inner:'내통', jacket:'쟈켓', outer:'외통'};
  const checked = document.getElementById('use_'+part).checked;
  const body = document.getElementById('body-'+part);
  const card = document.getElementById('card-'+part);
  body.style.opacity = checked ? '1' : '0.35';
  body.style.pointerEvents = checked ? '' : 'none';
  card.style.borderColor = checked ? '' : 'var(--border2)';
  calcAll();
  showToast(checked ? `✅ ${nameMap[part]} 포함됨` : `➖ ${nameMap[part]} 제외됨`);
}

function calcKg_plate(id,t){const eid=id*1.14;return(eid*eid*t*7.93)/1000000*2;}
function calcKg_body(id,h,t){return((id+t)*Math.PI*h*t*7.93)/1000000;}

function calcAll() {
  const rows=[];let matTotal=0;
  const parts=[
    {label:'내통', useId:'use_inner', idKey:'i_id',hKey:'i_h',tKey:'i_t',matKey:'i_mat'},
    {label:'쟈켓', useId:'use_jacket', idKey:'j_id',hKey:'j_h',tKey:'j_t',matKey:'j_mat'},
    {label:'외통', useId:'use_outer', idKey:'o_id',hKey:'o_h',tKey:'o_t',matKey:'o_mat'},
  ];
  parts.forEach(p=>{
    const useEl = document.getElementById(p.useId);
    if(useEl && !useEl.checked) return;
    const id=v(p.idKey),h=v(p.hKey),t=v(p.tKey),pt=t; // 경판두께 = 동체두께 자동
    const mat=document.getElementById(p.matKey).value;
    const price=getPrice(mat);
    const plateKg=calcKg_plate(id,pt),bodyKg=calcKg_body(id,h,t);
    const totalKg=plateKg+bodyKg,amount=Math.round(totalKg*price);
    matTotal+=amount;
    rows.push({label:p.label,plateKg,bodyKg,totalKg,price,amount,mat,t,pt});
  });
  const matWith10=Math.round(matTotal*1.1);
  const bujaSum=bujaItems.reduce((s,i)=>s+i.qty*i.price,0);
  const extraSum=extraItems.reduce((s,i)=>s+(i.qty*(i.price||0)),0);
  const subtotal=matWith10+bujaSum+extraSum;
  const overhead=Math.round(subtotal*0.1);
  const grandTotal=subtotal+overhead;
  calcResult={rows,matTotal,matWith10,bujaSum,extraSum,subtotal,overhead,grandTotal};
  const tbody=document.getElementById('calcBody');
  if(tbody){
    tbody.innerHTML=rows.map(r=>`<tr>
      <td><strong>${r.label}</strong> <span style="font-size:11px;color:var(--text2)">${r.mat}</span></td>
      <td class="tbl-num">${r.plateKg.toFixed(1)} kg<br><span style="font-size:10px;color:var(--text3);font-family:'Noto Sans KR',sans-serif">t=${r.pt}mm</span></td>
      <td class="tbl-num">${r.bodyKg.toFixed(1)} kg<br><span style="font-size:10px;color:var(--text3);font-family:'Noto Sans KR',sans-serif">t=${r.t}mm</span></td>
      <td class="tbl-num">${r.totalKg.toFixed(1)} kg</td>
      <td class="tbl-num">${fmt(r.amount)}</td>
    </tr>`).join('')+`
    <tr class="subtotal"><td colspan="4">자재비 소계</td><td>${fmt(matTotal)}</td></tr>
    <tr><td colspan="4" style="color:var(--text2);font-size:12px">10% 여분 포함</td><td class="tbl-num"><strong>${fmt(matWith10)}</strong></td></tr>
    <tr class="total"><td colspan="4">💰 견적 총액 (공과잡비 포함)</td><td>${fmt(grandTotal)}</td></tr>`;
  }
  document.getElementById('topTotal').textContent=fmt(grandTotal)+' 원';
}

function renderQuote() {
  const r=calcResult;
  if(!r.grandTotal){calcAll();return;}
  document.getElementById('q_mat').textContent=fmt(r.matWith10);
  document.getElementById('q_buja').textContent=fmt(r.bujaSum);
  document.getElementById('q_total').textContent=fmt(r.grandTotal);
  const bujaRows=bujaItems.map(i=>`<tr><td style="padding-left:28px;color:var(--text2)">└ ${i.name}</td><td style="color:var(--text2);font-size:12px">수량 ${i.qty}개 × ${fmt(i.price)}원</td><td class="tbl-num">${fmt(i.qty*i.price)}</td></tr>`).join('');
  const extraRows=extraItems.map(i=>`<tr><td style="padding-left:28px;color:var(--text2)">└ ${i.name}</td><td style="color:var(--text2);font-size:12px">${i.qty}${i.unit} × ${fmt(i.price)}원</td><td class="tbl-num">${fmt(i.qty*(i.price||0))}</td></tr>`).join('');
  document.getElementById('quoteBody').innerHTML=`
    <tr><td><strong>자재비</strong></td><td style="color:var(--text2)">내통+쟈켓+외통 (10%여분 포함)</td><td class="tbl-num">${fmt(r.matWith10)}</td></tr>
    <tr><td><strong>부자재</strong></td><td style="color:var(--text2)">${bujaItems.length}개 항목</td><td class="tbl-num">${fmt(r.bujaSum)}</td></tr>
    ${bujaRows}
    <tr><td><strong>기타비용</strong></td><td style="color:var(--text2)">${extraItems.length}개 항목</td><td class="tbl-num">${fmt(r.extraSum)}</td></tr>
    ${extraRows}
    <tr class="subtotal"><td colspan="2">소계</td><td>${fmt(r.subtotal)}</td></tr>
    <tr><td colspan="2">공과잡비 (10%)</td><td class="tbl-num">${fmt(r.overhead)}</td></tr>
    <tr class="total"><td colspan="2">🔷 최종 견적 총액</td><td>${fmt(r.grandTotal)}</td></tr>`;
}

function addBuja(name) {
  bujaItems.push({id:++idCnt,name,qty:1,price:0});
  renderBuja();calcAll();
  if(name) showToast(`✅ "${name}" 추가됨`);
}
function deleteBuja(id) {
  bujaItems=bujaItems.filter(i=>i.id!==id);
  renderBuja();calcAll();
}
function clearBuja() {
  if(!bujaItems.length) return;
  if(confirm('부자재 목록을 전체 삭제할까요?')) {
    bujaItems=[];
    presetOnSet.clear();
    renderBuja();renderPresets();calcAll();
  }
}
function updateBuja(id,field,val) {
  const item=bujaItems.find(i=>i.id===id);
  if(item){item[field]=field==='name'?val:+val;}
  const amtEl=document.getElementById('bamt_'+id);
  if(amtEl&&item) amtEl.textContent=fmt(item.qty*item.price);
  calcAll();
}
function renderBuja() {
  const tbody=document.getElementById('bujaBody');
  document.getElementById('bujaCount').textContent=bujaItems.length+'개';
  if(!bujaItems.length){tbody.innerHTML='<tr class="empty-row"><td colspan="6">검색하거나 직접 추가해 주세요</td></tr>';document.getElementById('bujaTotal').textContent='0 원';return;}
  tbody.innerHTML=bujaItems.map((item,i)=>`
    <tr>
      <td style="color:var(--text3);font-size:12px;text-align:center">${i+1}</td>
      <td><input class="tbl-input" value="${esc(item.name)}" placeholder="항목명" onchange="updateBuja(${item.id},'name',this.value)"></td>
      <td><input class="tbl-input tbl-num" type="number" min="1" value="${item.qty}" style="width:70px" onchange="updateBuja(${item.id},'qty',this.value)"></td>
      <td>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:1px">
          <input class="tbl-input tbl-num" type="number" min="0" value="${item.price}" placeholder="0"
            oninput="updateBuja(${item.id},'price',this.value);this.nextElementSibling.textContent=+this.value?fmtWon(this.value):''">
          <span style="font-size:10px;color:var(--accent);font-family:'JetBrains Mono',monospace;font-weight:600;min-height:13px">${item.price?fmtWon(item.price):''}</span>
        </div>
      </td>
      <td class="tbl-num" id="bamt_${item.id}">${fmt(item.qty*item.price)}</td>
      <td><button class="del-btn" onclick="deleteBuja(${item.id})">✕</button></td>
    </tr>`).join('');
  document.getElementById('bujaTotal').textContent=fmt(bujaItems.reduce((s,i)=>s+i.qty*i.price,0))+' 원';
}

async function doSearch() {
  const q=document.getElementById('searchInput').value.trim();
  if(!q) return;
  await runSearch(q);
}
function qs(q){document.getElementById('searchInput').value=q;runSearch(q);}
async function runSearch(q) {
  const btn=document.getElementById('searchBtn'),box=document.getElementById('aiResults');
  const chips=document.getElementById('resultChips'),label=document.getElementById('aiLabel');
  btn.disabled=true;box.style.display='block';
  label.textContent=`"${q}" 검색 중...`;
  chips.innerHTML='<div class="loading-msg">●&nbsp;●&nbsp;● AI가 관련 부품을 찾고 있어요...</div>';
  try {
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      model:'claude-sonnet-4-20250514',max_tokens:800,
      system:`스테인리스 탱크(쟈켓탱크, 쿠킹믹서, 추출탱크) 제작 전문가입니다.\n검색어에 맞는 부자재/부품 목록을 JSON 배열로만 응답하세요. 설명 없이 JSON만.\n형식: [{"name":"부품명 (규격/사양)"}]\n5~8개, 실제 탱크 제작에 쓰이는 구체적 품명과 규격 포함.`,
      messages:[{role:'user',content:`"${q}" 관련 스텐탱크 부자재를 JSON으로`}]})});
    const data=await res.json();
    const text=data.content[0].text.replace(/```json|```/g,'').trim();
    const results=JSON.parse(text);
    label.textContent=`"${q}" 검색 결과 — 클릭해서 추가`;
    chips.innerHTML=results.map(r=>`<div class="result-chip" onclick="addBuja('${esc(r.name)}')"><span class="plus">+</span><span>${r.name}</span></div>`).join('');
  } catch {
    chips.innerHTML='<div style="color:var(--red);font-size:12px">검색 오류. 직접 추가 버튼을 이용해 주세요.</div>';
  }
  btn.disabled=false;
}

function exportExcel() {
  if(!calcResult.grandTotal) calcAll();
  const r=calcResult,wb=XLSX.utils.book_new();
  const today=new Date().toLocaleDateString('ko-KR');
  const ws1=XLSX.utils.aoa_to_sheet([
    ['쟈켓탱크 견적서','','',''],['작성일',today,'',''],['','','',''],
    ['[ 자재비 ]','','',''],['구분','재질','KG','금액'],
    ...r.rows.map(row=>[row.label,row.mat,Math.round(row.totalKg*10)/10,row.amount]),
    ['자재비 소계','','',r.matTotal],['자재비 (10% 여분 포함)','','',r.matWith10],
    ['','','',''],
    ['[ 부자재 ]','','',''],['항목명','수량','단가','금액'],
    ...bujaItems.map(i=>[i.name,i.qty,i.price,i.qty*i.price]),
    ['부자재 합계','','',r.bujaSum],
    ['','','',''],
    ['[ 기타 비용 ]','','',''],['항목명','수량','단위','단가','금액'],
    ...extraItems.map(i=>[i.name,i.qty,i.unit,i.price||0,i.qty*(i.price||0)]),
    ['기타비용 합계','','','',r.extraSum],
    ['','','',''],
    ['소계','','','',r.subtotal],['공과잡비 (10%)','','','',r.overhead],
    ['★ 최종 견적 총액','','','',r.grandTotal]
  ]);
  ws1['!cols']=[{wch:24},{wch:12},{wch:12},{wch:12},{wch:16}];
  XLSX.utils.book_append_sheet(wb,ws1,'견적서');
  const ws2=XLSX.utils.aoa_to_sheet([['쟈켓탱크 치수 데이터',''],['항목','값'],['재질단가 304(1D)',v('price304')],['재질단가 316L(1D)',v('price316')],['',''],['내통 내경(mm)',v('i_id')],['내통 높이(mm)',v('i_h')],['내통 동체두께(mm)',v('i_t')],['내통 경판두께(mm)',v('i_pt')],['내통 재질',document.getElementById('i_mat').value],['',''],['쟈켓 내경(mm)',v('j_id')],['쟈켓 높이(mm)',v('j_h')],['쟈켓 두께(mm)',v('j_t')],['쟈켓 재질',document.getElementById('j_mat').value],['',''],['외통 내경(mm)',v('o_id')],['외통 높이(mm)',v('o_h')],['외통 두께(mm)',v('o_t')],['외통 재질',document.getElementById('o_mat').value]]);
  ws2['!cols']=[{wch:22},{wch:16}];
  XLSX.utils.book_append_sheet(wb,ws2,'치수데이터');
  const ws3=XLSX.utils.aoa_to_sheet([['부자재 목록','','',''],['No','항목명','수량','단가(원)','금액(원)'],...bujaItems.map((i,idx)=>[idx+1,i.name,i.qty,i.price,i.qty*i.price]),['','','','합계',r.bujaSum]]);
  ws3['!cols']=[{wch:5},{wch:35},{wch:8},{wch:14},{wch:16}];
  XLSX.utils.book_append_sheet(wb,ws3,'부자재목록');
  XLSX.writeFile(wb,`쟈켓탱크_견적_${today.replace(/\./g,'').replace(/ /g,'')}.xlsx`);
  showToast('📥 엑셀 저장 완료!');
}

function fmt(n){return Math.round(n||0).toLocaleString('ko-KR');}
function fmtWon(n){const v=Math.round(+n||0);return v?v.toLocaleString('ko-KR'):'0';}
// ══ 재질 시세 기록 ══
const PRICE_HIST_LS = 'fns_price_history_v1';
function loadPriceHistory(){ try{ const s=localStorage.getItem(PRICE_HIST_LS); if(s) return JSON.parse(s); }catch(e){} return []; }
function savePriceHistory(arr){ try{ localStorage.setItem(PRICE_HIST_LS, JSON.stringify(arr)); }catch(e){} }
let priceHistory = loadPriceHistory();

function saveMarketPrice(){
  const p304 = +document.getElementById('price304').value || 0;
  const p316 = +document.getElementById('price316').value || 0;
  if(!p304 && !p316){ showToast('⚠️ 단가를 먼저 입력해 주세요'); return; }
  const memo = prompt('메모를 입력하세요 (선택, 예: 포스코 공시가 / 거래처 견적)', '') ;
  const now = new Date();
  const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
  priceHistory.unshift({ id: Date.now(), date: dateStr, p304, p316, memo: memo||'' });
  savePriceHistory(priceHistory);
  renderPriceHistory();
  showToast('💾 시세 저장됐어요');
}

function applyHistoryPrice(id){
  const h = priceHistory.find(r=>r.id===id); if(!h) return;
  document.getElementById('price304').value = h.p304;
  document.getElementById('price316').value = h.p316;
  updatePreview('price304','prev304','원/kg');
  updatePreview('price316','prev316','원/kg');
  calcAll();
  showToast(`✅ ${h.date} 단가 적용됨`);
}

function deleteHistoryPrice(id){
  priceHistory = priceHistory.filter(r=>r.id!==id);
  savePriceHistory(priceHistory);
  renderPriceHistory();
}

function renderPriceHistory(){
  const list = document.getElementById('priceHistoryList');
  const empty = document.getElementById('priceHistoryEmpty');
  if(!list) return;
  if(!priceHistory.length){
    list.innerHTML=''; empty.style.display='block'; return;
  }
  empty.style.display='none';
  list.innerHTML = priceHistory.map(h=>`
    <div class="price-hist-row">
      <span class="price-hist-date">📅 ${h.date}</span>
      <div class="price-hist-vals">
        ${h.p304?`<span class="price-hist-chip">304 · ${h.p304.toLocaleString('ko-KR')}원</span>`:''}
        ${h.p316?`<span class="price-hist-chip s316">316L · ${h.p316.toLocaleString('ko-KR')}원</span>`:''}
      </div>
      ${h.memo?`<span class="price-hist-memo" title="${h.memo}">💬 ${h.memo}</span>`:''}
      <button class="price-hist-apply" onclick="applyHistoryPrice(${h.id})">적용</button>
      <button class="price-hist-del" onclick="deleteHistoryPrice(${h.id})">✕</button>
    </div>`).join('');
}

// ══ 콤마 미리보기 유틸 ══
function updatePreview(inputId, previewId, suffix){
  const num = +document.getElementById(inputId).value || 0;
  const el  = document.getElementById(previewId);
  if(!el) return;
  if(num === 0){ el.textContent = ''; el.className = 'money-preview zero'; return; }
  el.textContent = num.toLocaleString('ko-KR') + ' ' + (suffix||'원');
  el.className = 'money-preview';
}
// 구버전 호환
const showPreview = updatePreview;

// 부자재 테이블 단가칸 아래에 콤마 힌트 표시
function updatePriceHint(inputEl, hintId){
  const num = +inputEl.value || 0;
  const el  = document.getElementById(hintId);
  if(!el) return;
  el.textContent = num > 0 ? num.toLocaleString('ko-KR') + ' 원' : '';
}

// 초기 미리보기 일괄 렌더
function initPreviews(){
  updatePreview('price304','prev304','원/kg');
  updatePreview('price316','prev316','원/kg');
}
function esc(s){return String(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function showToast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2500);}

// PDF 분석
let pdfFiles=[],analysisData=null;
const dropZone=document.getElementById('dropZone');
dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('dragover');});
dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('dragover');addFiles(Array.from(e.dataTransfer.files).filter(f=>f.type==='application/pdf'));});
function onFileSelect(e){addFiles(Array.from(e.target.files));}
function addFiles(files){files.forEach(f=>{if(!pdfFiles.find(p=>p.name===f.name))pdfFiles.push(f);});renderFileList();}
function removeFile(idx){pdfFiles.splice(idx,1);renderFileList();}
function renderFileList(){
  const list=document.getElementById('fileList'),wrap=document.getElementById('analyzeWrap'),items=document.getElementById('fileItems');
  if(!pdfFiles.length){list.style.display='none';wrap.style.display='none';return;}
  list.style.display='block';wrap.style.display='block';
  items.innerHTML=pdfFiles.map((f,i)=>`<div class="file-item"><span class="fi-icon">📄</span><span class="fi-name">${f.name}</span><span class="fi-size">${(f.size/1024).toFixed(0)} KB</span><span class="fi-del" onclick="removeFile(${i})">✕</span></div>`).join('');
}
async function fileToBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(file);});}
async function analyzePDFs(){
  if(!pdfFiles.length) return;
  document.getElementById('analysisCard').style.display='block';
  document.getElementById('analysisLoading').style.display='block';
  document.getElementById('analysisResult').style.display='none';
  document.getElementById('analysisCard').scrollIntoView({behavior:'smooth'});
  const bar=document.getElementById('progressBar'),msg=document.getElementById('loadingMsg');
  let prog=0;const timer=setInterval(()=>{prog=Math.min(prog+3,85);bar.style.width=prog+'%';},200);
  try {
    msg.textContent=`PDF ${pdfFiles.length}장 변환 중...`;
    const contents=[];
    for(const f of pdfFiles){const b64=await fileToBase64(f);contents.push({type:'document',source:{type:'base64',media_type:'application/pdf',data:b64}});}
    msg.textContent='AI가 도면을 분석하고 있어요...';
    contents.push({type:'text',text:`이 도면들을 분석해서 스테인리스 탱크 견적에 필요한 정보를 추출해주세요.\n반드시 아래 JSON 형식으로만 응답하세요:\n{"tank_name":"탱크명","capacity":용량숫자,"dims":{"inner_id":null,"inner_h":null,"inner_t":null,"jacket_id":null,"jacket_h":null,"jacket_t":null,"outer_id":null,"outer_h":null,"outer_t":null},"material":{"inner":"재질","outer":"재질"},"parts":[{"name":"부품명","qty":1}],"notes":"특이사항"}`});
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2000,messages:[{role:'user',content:contents}]})});
    const data=await res.json();
    analysisData=JSON.parse(data.content[0].text.replace(/```json|```/g,'').trim());
    clearInterval(timer);bar.style.width='100%';
    await new Promise(r=>setTimeout(r,400));
    renderAnalysisResult(analysisData);
  } catch(e){clearInterval(timer);document.getElementById('loadingMsg').textContent='❌ 분석 오류. 다시 시도해주세요.';console.error(e);}
}
function renderAnalysisResult(d){
  document.getElementById('analysisLoading').style.display='none';
  document.getElementById('analysisResult').style.display='block';
  const dimMap=[{key:'inner_id',label:'내통 내경',unit:'mm'},{key:'inner_h',label:'내통 높이',unit:'mm'},{key:'inner_t',label:'내통 두께',unit:'mm'},{key:'jacket_id',label:'쟈켓 내경',unit:'mm'},{key:'jacket_h',label:'쟈켓 높이',unit:'mm'},{key:'jacket_t',label:'쟈켓 두께',unit:'mm'},{key:'outer_id',label:'외통 내경',unit:'mm'},{key:'outer_h',label:'외통 높이',unit:'mm'},{key:'outer_t',label:'외통 두께',unit:'mm'}];
  document.getElementById('extractedDims').innerHTML=dimMap.filter(m=>d.dims&&d.dims[m.key]).map(m=>`<div class="ext-dim"><div class="ed-label">${m.label}</div><div class="ed-val">${d.dims[m.key]}</div><div class="ed-unit">${m.unit}</div></div>`).join('')+(d.capacity?`<div class="ext-dim" style="border-color:var(--success)"><div class="ed-label">탱크 용량</div><div class="ed-val" style="color:var(--success)">${d.capacity}</div><div class="ed-unit">리터</div></div>`:'');
  document.getElementById('extractedParts').innerHTML=(d.parts||[]).map((p,i)=>`<div class="ext-part" id="ep_${i}" onclick="toggleExtPart(${i})">✓ ${p.name}${p.qty>1?' × '+p.qty:''}</div>`).join('');
  document.getElementById('analysisNote').innerHTML=`<strong>📋 ${d.tank_name||'탱크'}</strong><br>재질: 내통 ${d.material?.inner||'-'} / 외통 ${d.material?.outer||'-'}<br>${d.notes||''}`;
}
function toggleExtPart(i){document.getElementById('ep_'+i).classList.toggle('excluded');}
function applyAnalysis(){
  if(!analysisData) return;
  const d=analysisData;
  if(d.dims){
    if(d.dims.inner_id) document.getElementById('i_id').value=d.dims.inner_id;
    if(d.dims.inner_h) document.getElementById('i_h').value=d.dims.inner_h;
    if(d.dims.inner_t){document.getElementById('i_t').value=d.dims.inner_t;document.getElementById('i_pt').value=d.dims.inner_t;}
    if(d.dims.jacket_id) document.getElementById('j_id').value=d.dims.jacket_id;
    if(d.dims.jacket_h) document.getElementById('j_h').value=d.dims.jacket_h;
    if(d.dims.jacket_t) document.getElementById('j_t').value=d.dims.jacket_t;
    if(d.dims.outer_id) document.getElementById('o_id').value=d.dims.outer_id;
    if(d.dims.outer_h) document.getElementById('o_h').value=d.dims.outer_h;
    if(d.dims.outer_t) document.getElementById('o_t').value=d.dims.outer_t;
  }
  if(d.material?.inner){document.getElementById('i_mat').value=d.material.inner.includes('316')?'316':'304';}
  if(d.material?.outer){const mat=d.material.outer.includes('316')?'316':'304';document.getElementById('j_mat').value=mat;document.getElementById('o_mat').value=mat;}
  (d.parts||[]).forEach((p,i)=>{const el=document.getElementById('ep_'+i);if(el&&!el.classList.contains('excluded'))for(let q=0;q<(p.qty||1);q++)addBuja(p.name);});
  calcAll();showToast('✅ 치수 & 부품 모두 적용됐어요!');goPage('page-dim');
}

// 빠른 태그
const DEFAULT_TAGS=['맨홀','사이트글라스','레벨게이지','볼밸브','압력계','온도계','노즐/페롤','교반기','버핑','보온재','경판가공','다리/지지대'];
let quickTags=[...DEFAULT_TAGS];
function renderQuickTags(){
  const wrap=document.getElementById('quickTagWrap');if(!wrap)return;
  wrap.innerHTML=quickTags.map((tag,i)=>`<span class="qtag"><span onclick="qs('${esc(tag)}')" style="cursor:pointer">${tag}</span><span class="qtag-del" onclick="removeQuickTag(${i})">×</span></span>`).join('')+`<span class="qtag-add" onclick="promptAddTag()">＋ 추가</span>`;
}
function removeQuickTag(idx){quickTags.splice(idx,1);renderQuickTags();}
function promptAddTag(){const val=prompt('추가할 검색 태그를 입력하세요');if(val&&val.trim()){quickTags.push(val.trim());renderQuickTags();showToast(`✅ "${val.trim()}" 태그 추가됨`);}}

// ══ 로컬스토리지 저장/불러오기 ══
const LS_KEY = 'fns_presets_v1';

const DEFAULT_PRESETS = [
  {cat:'상부',items:[
    {name:'맨홀 450Ø 타원형 제작 (SUS304)',price:280000},
    {name:'사이트글라스 100Ø (Wiper Type)',price:85000},
    {name:'라이트글라스 100Ø',price:65000},
    {name:'압력계 100Ø (0~10kgf/cm²)',price:45000},
    {name:'온도계 바이메탈 63Ø',price:32000},
    {name:'안전밸브 (SUS304)',price:75000},
  ]},
  {cat:'측면',items:[
    {name:'레벨게이지 유리관식 (300mm)',price:95000},
    {name:'노즐 및 부품 일식',price:150000},
    {name:'페롤 피팅 1.5" (SUS304)',price:18000},
    {name:'페롤 피팅 2" (SUS304)',price:24000},
    {name:'볼밸브 1.5" (SUS304)',price:55000},
    {name:'바텀밸브 1.5" (SUS304)',price:65000},
  ]},
  {cat:'쟈켓',items:[
    {name:'쟈켓링 10T (SUS304)',price:45000},
    {name:'쟈켓 스팀 인렛/아웃렛 배관',price:120000},
    {name:'스팀트랩 (버킷식)',price:85000},
  ]},
  {cat:'하부/지지',items:[
    {name:'경판 가공 및 밴딩',price:180000},
    {name:'다리 제작 (SUS304, 4ea)',price:220000},
    {name:'높이조절 레벨풋 (4ea)',price:96000},
    {name:'캐스터 바퀴 100Ø (4ea)',price:120000},
    {name:'바퀴 플레이트 10T (4ea)',price:60000},
  ]},
  {cat:'가공/기타',items:[
    {name:'준택 가공비',price:200000},
    {name:'버핑비 (내면 경면)',price:300000},
    {name:'보온재 (글라스울)',price:150000},
    {name:'소모자재 일식',price:80000},
  ]},
];

// 로컬스토리지에서 불러오기 (없으면 기본값 사용)
function loadPresets() {
  try {
    const saved = localStorage.getItem(LS_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      // price 필드 없는 구버전 데이터 보정
      parsed.forEach(cat => cat.items.forEach(item => { if(item.price===undefined) item.price=0; }));
      return parsed;
    }
  } catch(e) { console.warn('프리셋 불러오기 실패', e); }
  return JSON.parse(JSON.stringify(DEFAULT_PRESETS)); // 깊은 복사
}

// 로컬스토리지에 저장
let saveTimer = null;
function savePresets() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    try {
      localStorage.setItem(LS_KEY, JSON.stringify(PRESETS));
      // 저장 표시
      const ind = document.getElementById('saveIndicator');
      if(ind){ ind.classList.add('show'); setTimeout(()=>ind.classList.remove('show'), 1500); }
    } catch(e) { console.warn('프리셋 저장 실패', e); }
  }, 400);
}

const PRESETS = loadPresets();

function renderPresets(){
  const wrap=document.getElementById('presetList');if(!wrap)return;
  wrap.innerHTML=PRESETS.map((cat,catIdx)=>`
    <div style="margin-bottom:16px" id="cat_block_${catIdx}">
      <div class="cat-header">
        <div class="cat-title-wrap">
          <span class="cat-title" id="cat_title_${catIdx}" ondblclick="startEditCatName(${catIdx})" title="더블클릭으로 이름 변경">${cat.cat}</span>
          <span style="font-size:10px;color:var(--text3);font-weight:400">✎</span>
        </div>
        <div class="cat-actions">
          <span class="qtag-add" style="font-size:11px;padding:3px 10px" onclick="promptAddPreset(${catIdx})">＋ 부품추가</span>
          <button class="cat-del-btn" onclick="deleteCategory(${catIdx})" title="카테고리 삭제">🗑</button>
        </div>
      </div>
      <div class="preset-chip-wrap" id="chip_group_${catIdx}" style="display:flex;flex-wrap:wrap;gap:6px;min-height:32px;">
        ${cat.items.map((item,itemIdx)=>{
          const key=catIdx+'_'+itemIdx;
          const isOn=presetOnSet.has(key);
          const priceVal=item.price||0;
          return `<div class="preset-chip${isOn?' preset-on':''}" id="preset_${catIdx}_${itemIdx}"
              data-cat="${catIdx}" data-item="${itemIdx}"
              onclick="togglePreset(${catIdx},${itemIdx},this)">
            <span class="preset-drag-handle" onclick="event.stopPropagation()" title="드래그로 이동">⠿</span>
            <span class="preset-check">${isOn?'✓':'+'}</span>
            <span class="preset-name">${item.name}</span>
            <span class="preset-price-wrap" onclick="event.stopPropagation()" title="단가 입력 (Enter로 저장)">
              <input class="preset-price-input"
                type="number" min="0" step="1000"
                value="${priceVal}"
                placeholder="단가"
                oninput="updatePresetPrice(${catIdx},${itemIdx},this.value);this.title=fmtWon(this.value)+'원'"
                onchange="updatePresetPrice(${catIdx},${itemIdx},this.value)"
                onkeydown="if(event.key==='Enter')this.blur()"
                title="${priceVal?fmtWon(priceVal)+'원':''}"
              >
              <span class="preset-price-unit">원</span>
            </span>
            <span class="preset-edit" onclick="openEditPreset(${catIdx},${itemIdx},event)" title="이름 수정">✎</span>
            <span class="preset-del" onclick="removePreset(${catIdx},${itemIdx},event)" title="삭제">✕</span>
          </div>`;
        }).join('')}
      </div>
    </div>`).join('')
  + `<div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
      <button class="add-cat-btn" style="flex:1;margin-right:8px" onclick="addCategory()">＋ 새 카테고리 추가</button>
      <button class="btn btn-ghost" style="font-size:11px;padding:6px 12px;white-space:nowrap" onclick="resetPresets()">🔄 기본값으로</button>
      <span class="save-indicator" id="saveIndicator" style="margin-left:8px">💾 저장됨</span>
    </div>`;
  initPresetDrag();
}

// 프리셋 드래그 정렬
function initPresetDrag(){
  if(typeof Sortable === 'undefined') return;
  PRESETS.forEach((cat, catIdx)=>{
    const el = document.getElementById('chip_group_'+catIdx);
    if(!el) return;
    Sortable.create(el, {
      group: 'presets',          // 같은 group끼리 카테고리 간 이동 가능
      handle: '.preset-drag-handle',
      animation: 150,
      ghostClass: 'preset-drag-ghost',
      chosenClass: 'preset-drag-chosen',
      onEnd(evt){
        const fromCat = +evt.from.id.replace('chip_group_','');
        const toCat   = +evt.to.id.replace('chip_group_','');
        const oldIdx  = evt.oldIndex;
        const newIdx  = evt.newIndex;
        if(fromCat === toCat && oldIdx === newIdx) return;
        // 데이터 이동
        const [moved] = PRESETS[fromCat].items.splice(oldIdx, 1);
        PRESETS[toCat].items.splice(newIdx, 0, moved);
        savePresets();
        renderPresets(); // re-render로 인덱스 정합성 유지
      }
    });
  });
}

// 카테고리 이름 인라인 편집
function startEditCatName(catIdx){
  const titleEl=document.getElementById('cat_title_'+catIdx);
  const oldName=PRESETS[catIdx].cat;
  const input=document.createElement('input');
  input.className='cat-title-input';
  input.value=oldName;
  titleEl.replaceWith(input);
  input.focus();input.select();
  const finish=()=>{
    const newName=input.value.trim()||oldName;
    PRESETS[catIdx].cat=newName;
    savePresets();
    renderPresets();
    if(newName!==oldName) showToast(`✅ "${newName}"으로 변경됨`);
  };
  input.addEventListener('blur',finish);
  input.addEventListener('keydown',e=>{if(e.key==='Enter')input.blur();if(e.key==='Escape'){PRESETS[catIdx].cat=oldName;renderPresets();}});
}

// 카테고리 삭제
function deleteCategory(catIdx){
  if(PRESETS[catIdx].items.length>0){
    if(!confirm(`"${PRESETS[catIdx].cat}" 카테고리와 부품 ${PRESETS[catIdx].items.length}개를 모두 삭제할까요?`)) return;
    // 켜진 항목들 부자재 목록에서도 제거
    PRESETS[catIdx].items.forEach((_,itemIdx)=>{
      const key=catIdx+'_'+itemIdx;
      if(presetOnSet.has(key)){
        const name=PRESETS[catIdx].items[itemIdx].name;
        const idx=bujaItems.findIndex(i=>i.name===name);
        if(idx!==-1) bujaItems.splice(idx,1);
        presetOnSet.delete(key);
      }
    });
  }
  PRESETS.splice(catIdx,1);
  // presetOnSet key 재조정
  const newSet=new Set();
  for(const k of presetOnSet){
    const [ci,ii]=k.split('_').map(Number);
    if(ci<catIdx) newSet.add(k);
    else if(ci>catIdx) newSet.add((ci-1)+'_'+ii);
    // ci===catIdx는 이미 지웠으므로 skip
  }
  presetOnSet.clear();for(const k of newSet)presetOnSet.add(k);
  savePresets();
  renderBuja();calcAll();renderPresets();
  showToast('🗑️ 카테고리 삭제됨');
}

// 카테고리 추가
function addCategory(){
  const name=prompt('새 카테고리 이름을 입력하세요');
  if(!name||!name.trim()) return;
  PRESETS.push({cat:name.trim(),items:[]});
  savePresets();
  renderPresets();
  showToast(`✅ "${name.trim()}" 카테고리 추가됨`);
  // 새로 생긴 카테고리로 스크롤
  setTimeout(()=>{const last=document.getElementById('cat_block_'+(PRESETS.length-1));if(last)last.scrollIntoView({behavior:'smooth',block:'nearest'});},100);
}

// 단가 업데이트 → 로컬스토리지 저장 + 부자재 목록 반영
function updatePresetPrice(catIdx, itemIdx, val) {
  const price = Math.round(+val) || 0;
  PRESETS[catIdx].items[itemIdx].price = price;
  // 이미 체크된 항목이면 부자재 목록 단가도 실시간 반영
  const key = catIdx+'_'+itemIdx;
  if (presetOnSet.has(key)) {
    const name = PRESETS[catIdx].items[itemIdx].name;
    const item = bujaItems.find(i => i.name === name);
    if (item) {
      item.price = price;
      renderBuja();
      calcAll();
    }
  }
  savePresets();
}

function promptAddPreset(catIdx){
  const val=prompt(`"${PRESETS[catIdx].cat}" 카테고리에 추가할 부품명을 입력하세요`);
  if(!val||!val.trim()) return;
  const priceStr=prompt(`"${val.trim()}" 단가를 입력하세요 (원, 숫자만)`,'0');
  const price=Math.round(+priceStr)||0;
  PRESETS[catIdx].items.push({name:val.trim(),price});
  savePresets();
  renderPresets();
  showToast(`✅ "${val.trim()}" 추가됨`);
}

function resetPresets(){
  if(!confirm('단가 포함 모든 프리셋을 기본값으로 초기화할까요?\n(추가/수정한 내용이 사라집니다)')) return;
  presetOnSet.clear();
  bujaItems=[];
  // PRESETS 배열 내용을 기본값으로 교체
  PRESETS.splice(0, PRESETS.length, ...JSON.parse(JSON.stringify(DEFAULT_PRESETS)));
  localStorage.removeItem(LS_KEY);
  renderBuja();calcAll();renderPresets();
  showToast('🔄 기본값으로 초기화됨');
}

// ✅ 핵심 수정 1: confirm 제거, stopPropagation으로 토글 방지
function openEditPreset(catIdx, itemIdx, event){
  event.stopPropagation();
  const item = PRESETS[catIdx].items[itemIdx];
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'presetEditModal';
  overlay.onclick = e=>{ if(e.target===overlay) closePresetEditModal(); };
  overlay.innerHTML = `
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-title">✎ 부품 수정</div>
      <div class="modal-field">
        <label>부품 이름</label>
        <input id="pe_name" value="${esc(item.name)}" placeholder="부품명" autofocus>
      </div>
      <div class="modal-field">
        <label>단가 (원)</label>
        <input id="pe_price" type="number" min="0" step="1000" value="${item.price||0}" placeholder="0">
        <div id="pe_preview" style="font-size:11px;color:var(--accent);font-family:'JetBrains Mono',monospace;font-weight:600;margin-top:4px">${item.price?fmtWon(item.price)+' 원':''}</div>
      </div>
      <div class="modal-btns">
        <button class="btn btn-ghost" onclick="closePresetEditModal()">취소</button>
        <button class="btn btn-primary" onclick="confirmEditPreset(${catIdx},${itemIdx})">저장</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  // 단가 입력 시 콤마 미리보기
  setTimeout(()=>{
    const nameEl = document.getElementById('pe_name');
    const priceEl = document.getElementById('pe_price');
    const previewEl = document.getElementById('pe_preview');
    if(nameEl) nameEl.focus();
    if(priceEl) priceEl.addEventListener('input', ()=>{
      previewEl.textContent = priceEl.value ? fmtWon(priceEl.value)+' 원' : '';
    });
    // 엔터로 저장
    [nameEl, priceEl].forEach(el=>{ if(el) el.addEventListener('keydown', e=>{ if(e.key==='Enter') confirmEditPreset(catIdx, itemIdx); }); });
  }, 50);
}

function closePresetEditModal(){
  const el = document.getElementById('presetEditModal');
  if(el) el.remove();
}

function confirmEditPreset(catIdx, itemIdx){
  const name  = document.getElementById('pe_name').value.trim();
  const price = Math.round(+document.getElementById('pe_price').value) || 0;
  if(!name){ showToast('⚠️ 부품 이름을 입력해 주세요'); return; }
  const item = PRESETS[catIdx].items[itemIdx];
  const oldName = item.name;
  item.name  = name;
  item.price = price;
  // bujaItems에 이미 추가된 경우 이름 동기화
  bujaItems.forEach(b=>{ if(b.name===oldName) b.name=name; });
  savePresets();
  renderPresets();
  renderBuja();
  calcAll();
  closePresetEditModal();
  showToast(`✅ "${name}" 수정됐어요`);
}

function removePreset(catIdx,itemIdx,event){
  event.stopPropagation();
  const key=catIdx+'_'+itemIdx;
  // 켜진 상태면 부자재 목록에서도 제거
  if(presetOnSet.has(key)){
    const name=PRESETS[catIdx].items[itemIdx].name;
    const idx=bujaItems.findIndex(i=>i.name===name);
    if(idx!==-1){bujaItems.splice(idx,1);}
    presetOnSet.delete(key);
  }
  PRESETS[catIdx].items.splice(itemIdx,1);
  // 같은 카테고리에서 뒤 인덱스 key 재조정
  const newSet=new Set();
  for(const k of presetOnSet){
    const [ci,ii]=k.split('_').map(Number);
    if(ci===catIdx&&ii>itemIdx) newSet.add(ci+'_'+(ii-1));
    else newSet.add(k);
  }
  presetOnSet.clear();
  for(const k of newSet) presetOnSet.add(k);
  savePresets();
  renderBuja();calcAll();renderPresets();
  showToast('🗑️ 부품 삭제됨');
}

// ✅ togglePreset: 단가 자동 반영
function togglePreset(catIdx,itemIdx,el){
  const key=catIdx+'_'+itemIdx;
  const item=PRESETS[catIdx].items[itemIdx];
  if(presetOnSet.has(key)){
    const idx=bujaItems.findIndex(i=>i.name===item.name);
    if(idx!==-1){bujaItems.splice(idx,1);renderBuja();calcAll();}
    presetOnSet.delete(key);
    el.classList.remove('preset-on');
    el.querySelector('.preset-check').textContent='+';
  } else {
    // 단가 자동 세팅해서 추가
    bujaItems.push({id:++idCnt, name:item.name, qty:1, price:item.price||0});
    renderBuja();calcAll();
    if(item.name) showToast(`✅ "${item.name}" 추가됨`);
    presetOnSet.add(key);
    el.classList.add('preset-on');
    el.querySelector('.preset-check').textContent='✓';
  }
}

// 용량 계산
function onTypeChange(){const type=document.querySelector('input[name="bottomType"]:checked').value;document.getElementById('cone-angle-group').style.display=type==='cone'?'block':'none';calcVol();}
function getVolLiter(id_mm,h_mm,bottomType,coneAngle){
  const r=id_mm/2,PI=Math.PI;
  const bodyVol=PI*r*r*h_mm/1000000;
  const topDepth=id_mm*0.1355;
  const topVol=(PI*topDepth/6)*(3*r*r+topDepth*topDepth)/1000000;
  let bottomVol=0;
  if(bottomType==='dish'){const bd=id_mm*0.1355;bottomVol=(PI*bd/6)*(3*r*r+bd*bd)/1000000;}
  else if(bottomType==='cone'){const coneH=r/Math.tan((coneAngle/2)*PI/180);bottomVol=(PI*r*r*coneH/3)/1000000;}
  return{bodyVol,topVol,bottomVol,total:bodyVol+topVol+bottomVol};
}
function calcVol(){
  const vidEl=document.getElementById('v_id'); if(!vidEl) return;
  const id=+vidEl.value||0, h=+document.getElementById('v_h').value||0;
  const typeEl=document.querySelector('input[name="bottomType"]:checked'); if(!typeEl) return;
  const type=typeEl.value;
  const coneAngle=+document.getElementById('v_cone_angle').value;
  if(!id||!h) return;
  const{bodyVol,topVol,bottomVol,total}=getVolLiter(id,h,type,coneAngle);
  document.getElementById('volResult').style.display='block';
  document.getElementById('vol_body').textContent=bodyVol.toFixed(1);
  document.getElementById('vol_heads').textContent=(topVol+bottomVol).toFixed(1);
  document.getElementById('vol_total').textContent=total.toFixed(1);
  const typeLabel={dish:'10%경판',flat:'평경판',cone:`콘(${coneAngle}°)`}[type];
  document.getElementById('volFormula').innerHTML=`<strong>계산 조건</strong>: 내경 ${id}mm × 직선부 높이 ${h}mm / 하부: ${typeLabel}<br>동체: <strong>${bodyVol.toFixed(2)}L</strong> / 상부(10%경판): <strong>${topVol.toFixed(2)}L</strong> / 하부(${typeLabel}): <strong>${bottomVol.toFixed(2)}L</strong>`;
}
function calcReverse(){
  const targetEl=document.getElementById('target_vol'); if(!targetEl) return;
  const target=+targetEl.value||0;
  const ratio=+document.getElementById('rev_ratio').value;
  const bottom=document.getElementById('rev_bottom').value;
  if(!target) return;
  const candidates=[];
  for(let id=300;id<=3000;id+=50){
    const r=id/2,PI=Math.PI;
    const topDepth=id*0.1355,topVol=(PI*topDepth/6)*(3*r*r+topDepth*topDepth)/1000000;
    let botVol=0;
    if(bottom==='dish'){const bd=id*0.1355;botVol=(PI*bd/6)*(3*r*r+bd*bd)/1000000;}
    else if(bottom==='cone'){botVol=(PI*r*r*(r/Math.tan(45*PI/180))/3)/1000000;}
    const bodyNeeded=target-topVol-botVol;if(bodyNeeded<=0)continue;
    const h=(bodyNeeded*1000000)/(PI*r*r);
    if(h/id<ratio*0.5||h/id>ratio*2.5)continue;
    const h50=Math.round(h/50)*50;
    const{total}=getVolLiter(id,h50,bottom,90);
    const diff=(total-target)/target*100;
    if(Math.abs(diff)<=15)candidates.push({id,h:h50,total,diff});
  }
  candidates.sort((a,b)=>Math.abs(a.diff)-Math.abs(b.diff));
  const top5=candidates.slice(0,5);
  document.getElementById('revResult').style.display='block';
  const tbody=document.getElementById('revBody');
  if(!top5.length){tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--text2);padding:20px">추천 치수를 찾지 못했어요.</td></tr>';return;}
  const bl={dish:'10%경판',flat:'평경판',cone:'콘타입(90°)'}[bottom];
  tbody.innerHTML=top5.map(c=>`<tr><td><strong>${c.id}</strong></td><td><strong>${c.h}</strong></td><td>${bl}</td><td class="tbl-num">${c.total.toFixed(1)}</td><td style="color:${Math.abs(c.diff)<5?'var(--success)':'var(--warn)'}">${c.diff>0?'+':''}${c.diff.toFixed(1)}%</td><td><button class="btn btn-primary" style="padding:5px 12px;font-size:12px" onclick="applyDim(${c.id},${c.h})">적용</button></td></tr>`).join('');
}
function applyDim(id,h){
  document.getElementById('i_id').value=id;document.getElementById('i_h').value=h;
  document.getElementById('j_id').value=id+102;document.getElementById('j_h').value=Math.round(h*0.5/50)*50;
  document.getElementById('o_id').value=id+102+76;document.getElementById('o_h').value=h;
  calcAll();goPage('page-dim');showToast(`✅ 내경 ${id}mm × 높이 ${h}mm 적용됨`);
}

// ══ PDF 미리보기 ══
function openPdfPreview(){
  if(!calcResult.grandTotal) calcAll();
  renderPdfPaper();
  document.getElementById('pdfModal').style.display='block';
  document.body.style.overflow='hidden';
}
function closePdfPreview(){
  document.getElementById('pdfModal').style.display='none';
  document.body.style.overflow='';
}

function renderPdfPaper(){
  const r = calcResult;
  const co = loadCompanyInfo();
  const stamp = localStorage.getItem('fns_stamp_v1');
  const coName = co.name || 'FNS TECH';
  const today = new Date().toLocaleDateString('ko-KR');
  const bujaRows = bujaItems.map(i=>`
    <tr>
      <td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;font-size:12px">${i.name}</td>
      <td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;text-align:center">${i.qty}</td>
      <td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;text-align:right;font-family:monospace">${fmt(i.price)}</td>
      <td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;text-align:right;font-family:monospace">${fmt(i.qty*i.price)}</td>
    </tr>`).join('');
  const extraRows = extraItems.map(i=>`
    <tr>
      <td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;font-size:12px">${i.name}</td>
      <td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;text-align:center">${i.qty} ${i.unit}</td>
      <td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;text-align:right;font-family:monospace">${fmt(i.price||0)}</td>
      <td style="padding:6px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;text-align:right;font-family:monospace">${fmt(i.qty*(i.price||0))}</td>
    </tr>`).join('');

  document.getElementById('pdfPaper').innerHTML = `
    <!-- 헤더: 왼쪽=견적서 타이틀, 오른쪽=회사정보+도장 -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;padding-bottom:18px;border-bottom:3px solid #1e3a8a">
      <!-- 왼쪽: 타이틀 -->
      <div>
        <div style="font-size:28px;font-weight:800;color:#1e3a8a;letter-spacing:-0.5px">견 적 서</div>
        <div style="font-size:12px;color:#6b7280;margin-top:4px">QUOTATION</div>
        <div style="font-size:11px;color:#6b7280;margin-top:10px">작성일: ${today}</div>
      </div>
      <!-- 오른쪽: 회사정보 + 도장 -->
      <div style="display:flex;align-items:flex-start;gap:16px">
        <div style="text-align:right">
          <div style="font-size:17px;font-weight:700;color:#111">${coName}</div>
          ${co.ceo  ? `<div style="font-size:12px;color:#374151;margin-top:2px">대표 ${co.ceo}</div>` : ''}
          ${co.tel  ? `<div style="font-size:11px;color:#6b7280;margin-top:2px">☎ ${co.tel}</div>` : ''}
          ${co.email? `<div style="font-size:11px;color:#6b7280">✉ ${co.email}</div>` : ''}
          ${co.biz  ? `<div style="font-size:11px;color:#9ca3af;margin-top:2px">사업자 ${co.biz}</div>` : ''}
          ${co.addr ? `<div style="font-size:10px;color:#9ca3af;margin-top:2px">${co.addr}</div>` : ''}
          <div style="font-size:11px;color:#374151;margin-top:8px;font-weight:600">위와 같이 견적합니다.</div>
        </div>
        <!-- 도장 -->
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:72px">
          ${stamp
            ? `<img src="${stamp}" style="width:72px;height:72px;object-fit:contain">`
            : `<div style="width:68px;height:68px;border:1.5px dashed #d1d5db;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:12px">(인)</div>`
          }
        </div>
      </div>
    </div>

    <!-- 자재비 -->
    <div style="margin-bottom:24px">
      <div style="font-size:13px;font-weight:700;color:#1e3a8a;margin-bottom:8px;padding:6px 10px;background:#eff6ff;border-radius:6px">■ 자재비</div>
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:#f9fafb">
            <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:left;border-bottom:2px solid #e5e7eb">구분</th>
            <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:right;border-bottom:2px solid #e5e7eb">경판 KG</th>
            <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:right;border-bottom:2px solid #e5e7eb">동체 KG</th>
            <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:right;border-bottom:2px solid #e5e7eb">금액 (원)</th>
          </tr>
        </thead>
        <tbody>
          ${r.rows.map(row=>`
          <tr>
            <td style="padding:7px 10px;border-bottom:1px solid #e5e7eb;font-size:12px"><strong>${row.label}</strong> <span style="color:#9ca3af">${row.mat}</span></td>
            <td style="padding:7px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;text-align:right;font-family:monospace">${row.plateKg.toFixed(1)}</td>
            <td style="padding:7px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;text-align:right;font-family:monospace">${row.bodyKg.toFixed(1)}</td>
            <td style="padding:7px 10px;border-bottom:1px solid #e5e7eb;font-size:12px;text-align:right;font-family:monospace">${fmt(row.amount)}</td>
          </tr>`).join('')}
          <tr style="background:#f0f9ff">
            <td colspan="3" style="padding:8px 10px;font-size:12px;font-weight:700;color:#1e3a8a">자재비 소계 (10% 여분 포함)</td>
            <td style="padding:8px 10px;font-size:13px;font-weight:700;text-align:right;font-family:monospace;color:#1e3a8a">${fmt(r.matWith10)}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 부자재 -->
    ${bujaItems.length?`
    <div style="margin-bottom:24px">
      <div style="font-size:13px;font-weight:700;color:#1e3a8a;margin-bottom:8px;padding:6px 10px;background:#eff6ff;border-radius:6px">■ 부자재 (${bujaItems.length}개 항목)</div>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="background:#f9fafb">
          <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:left;border-bottom:2px solid #e5e7eb">항목</th>
          <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:center;border-bottom:2px solid #e5e7eb">수량</th>
          <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:right;border-bottom:2px solid #e5e7eb">단가</th>
          <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:right;border-bottom:2px solid #e5e7eb">금액</th>
        </tr></thead>
        <tbody>${bujaRows}</tbody>
        <tr style="background:#f0f9ff">
          <td colspan="3" style="padding:8px 10px;font-size:12px;font-weight:700;color:#1e3a8a">부자재 합계</td>
          <td style="padding:8px 10px;font-size:13px;font-weight:700;text-align:right;font-family:monospace;color:#1e3a8a">${fmt(r.bujaSum)}</td>
        </tr>
      </table>
    </div>`:''}

    <!-- 기타비용 -->
    ${extraItems.length?`
    <div style="margin-bottom:24px">
      <div style="font-size:13px;font-weight:700;color:#1e3a8a;margin-bottom:8px;padding:6px 10px;background:#eff6ff;border-radius:6px">■ 기타비용</div>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="background:#f9fafb">
          <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:left;border-bottom:2px solid #e5e7eb">항목</th>
          <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:center;border-bottom:2px solid #e5e7eb">수량</th>
          <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:right;border-bottom:2px solid #e5e7eb">단가</th>
          <th style="padding:8px 10px;font-size:11px;font-weight:600;color:#6b7280;text-align:right;border-bottom:2px solid #e5e7eb">금액</th>
        </tr></thead>
        <tbody>${extraRows}</tbody>
        <tr style="background:#f0f9ff">
          <td colspan="3" style="padding:8px 10px;font-size:12px;font-weight:700;color:#1e3a8a">기타비용 합계</td>
          <td style="padding:8px 10px;font-size:13px;font-weight:700;text-align:right;font-family:monospace;color:#1e3a8a">${fmt(r.extraSum)}</td>
        </tr>
      </table>
    </div>`:''}

    <!-- 최종 합계 -->
    <div style="border-top:2px solid #1e3a8a;padding-top:16px;margin-top:8px">
      <table style="width:100%;border-collapse:collapse">
        <tr>
          <td style="padding:8px 10px;font-size:13px;color:#374151">소계</td>
          <td style="padding:8px 10px;font-size:13px;text-align:right;font-family:monospace">${fmt(r.subtotal)} 원</td>
        </tr>
        <tr>
          <td style="padding:8px 10px;font-size:13px;color:#374151">공과잡비 (10%)</td>
          <td style="padding:8px 10px;font-size:13px;text-align:right;font-family:monospace">${fmt(r.overhead)} 원</td>
        </tr>
        <tr style="background:#1e3a8a;border-radius:8px">
          <td style="padding:14px 10px;font-size:16px;font-weight:800;color:#fff">★ 최종 견적 총액</td>
          <td style="padding:14px 10px;font-size:20px;font-weight:800;text-align:right;font-family:monospace;color:#93c5fd">${fmt(r.grandTotal)} 원</td>
        </tr>
      </table>
    </div>

    <!-- 계좌 정보 강조 박스 -->
    ${(co.bank || co.account) ? `
    <div style="margin-top:20px;background:linear-gradient(135deg,#1e3a8a 0%,#1d4ed8 100%);border-radius:10px;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="font-size:22px">💳</div>
        <div>
          <div style="font-size:10px;color:#93c5fd;font-weight:600;letter-spacing:0.8px;margin-bottom:2px">입금 계좌</div>
          <div style="font-size:15px;font-weight:800;color:#fff;font-family:monospace;letter-spacing:1px">${co.account||''}</div>
        </div>
      </div>
      <div style="text-align:right">
        ${co.bank ? `<div style="font-size:12px;font-weight:700;color:#bfdbfe">${co.bank}</div>` : ''}
        ${co.depositor ? `<div style="font-size:11px;color:#93c5fd;margin-top:2px">예금주: ${co.depositor}</div>` : ''}
      </div>
    </div>` : ''}

    <!-- 특이사항 -->
    ${quoteNotes.length ? `
    <div style="margin-top:16px;padding:14px 16px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px">
      <div style="font-size:12px;font-weight:700;color:#374151;margin-bottom:8px">※ 특이사항</div>
      ${quoteNotes.map(n=>`<div style="font-size:11px;color:#6b7280;line-height:1.9">※ ${n.label}${n.value ? ' — ' + n.value : ''}</div>`).join('')}
    </div>` : ''}
  `;
}

function downloadPdf(){
  const paper = document.getElementById('pdfPaper');
  const style = `<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap');
    body{margin:0;padding:0;background:#fff;font-family:'Noto Sans KR',sans-serif;}
  </style>`;
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">${style}</head><body>${paper.outerHTML}</body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const win = window.open(url,'_blank');
  if(win){
    win.onload = ()=>{
      setTimeout(()=>{ win.print(); },500);
    };
  } else {
    // 팝업 차단 시 직접 다운로드
    const a = document.createElement('a');
    a.href = url; a.download = `견적서_${new Date().toLocaleDateString('ko-KR').replace(/\./g,'').replace(/ /g,'')}.html`;
    a.click();
  }
  showToast('🖨️ 인쇄/저장 창이 열렸어요 (PDF로 저장 선택)');
}

function emailQuote(){
  if(!calcResult.grandTotal) calcAll();
  const today = new Date().toLocaleDateString('ko-KR');
  const r = calcResult;
  const subject = encodeURIComponent(`[FNS TECH] 견적서 - ${today}`);
  const body = encodeURIComponent(
`안녕하세요.

FNS TECH 쟈켓탱크 견적서를 보내드립니다.

■ 견적 요약 (${today} 기준)
─────────────────────
자재비 (10%여분 포함) : ${fmt(r.matWith10)} 원
부자재 합계           : ${fmt(r.bujaSum)} 원
기타비용 합계         : ${fmt(r.extraSum)} 원
소계                  : ${fmt(r.subtotal)} 원
공과잡비 (10%)        : ${fmt(r.overhead)} 원
─────────────────────
★ 최종 견적 총액     : ${fmt(r.grandTotal)} 원
(VAT 별도)

자세한 내역은 첨부 파일을 확인해 주세요.

감사합니다.
FNS TECH`);
  window.location.href = `mailto:?subject=${subject}&body=${body}`;
  showToast('📧 이메일 앱이 열렸어요');
}
// ══ 견적 특이사항 ══
const NOTES_LS = 'fns_quote_notes_v1';
const DEFAULT_NOTES = [
  {id:1, label:'부가세(VAT)', value:'별도'},
  {id:2, label:'견적 유효기간', value:'발행일로부터 30일'},
];
function loadQuoteNotes(){ try{ const s=localStorage.getItem(NOTES_LS); return s?JSON.parse(s):JSON.parse(JSON.stringify(DEFAULT_NOTES)); }catch(e){ return JSON.parse(JSON.stringify(DEFAULT_NOTES)); } }
function saveQuoteNotes(){ try{ localStorage.setItem(NOTES_LS, JSON.stringify(quoteNotes)); }catch(e){} }
let quoteNotes = loadQuoteNotes();
let noteIdCnt = Math.max(0, ...quoteNotes.map(n=>n.id));

function renderQuoteNotes(){
  const el = document.getElementById('quoteNoteList'); if(!el) return;
  if(!quoteNotes.length){
    el.innerHTML = `<div style="font-size:12px;color:var(--text3);text-align:center;padding:16px 0">항목이 없어요. ＋ 항목 추가를 눌러보세요.</div>`;
    return;
  }
  el.innerHTML = quoteNotes.map(n=>`
    <div style="display:flex;align-items:center;gap:8px;background:var(--surface2);border-radius:8px;padding:8px 12px">
      <span style="font-size:12px;color:var(--text3);flex-shrink:0">※</span>
      <input class="tbl-input" value="${esc(n.label)}" placeholder="항목 (예: 납기)" style="flex:0 0 140px;font-weight:600"
        onchange="updateNote(${n.id},'label',this.value)">
      <span style="font-size:12px;color:var(--text3);flex-shrink:0">—</span>
      <input class="tbl-input" value="${esc(n.value)}" placeholder="내용 (예: 계약 후 6주)" style="flex:1"
        onchange="updateNote(${n.id},'value',this.value)">
      <button class="del-btn" onclick="deleteNote(${n.id})">✕</button>
    </div>`).join('');
}
function updateNote(id, field, val){
  const n = quoteNotes.find(n=>n.id===id); if(!n) return;
  n[field] = val; saveQuoteNotes();
}
function addQuoteNote(){
  quoteNotes.push({id:++noteIdCnt, label:'새 항목', value:''});
  saveQuoteNotes(); renderQuoteNotes();
  // 마지막 항목 첫 input 포커스
  setTimeout(()=>{
    const inputs = document.querySelectorAll('#quoteNoteList input');
    if(inputs.length) inputs[inputs.length-2].focus();
  }, 50);
}
function deleteNote(id){
  quoteNotes = quoteNotes.filter(n=>n.id!==id);
  saveQuoteNotes(); renderQuoteNotes();
}

// ══ 회사 정보 ══
const CO_LS = 'fns_company_v1';
function loadCompanyInfo(){ try{ const s=localStorage.getItem(CO_LS); return s?JSON.parse(s):{}; }catch(e){ return {}; } }
function saveCompanyInfo(){
  const info = {
    name:       document.getElementById('co_name').value,
    ceo:        document.getElementById('co_ceo').value,
    biz:        document.getElementById('co_biz').value,
    tel:        document.getElementById('co_tel').value,
    email:      document.getElementById('co_email').value,
    addr:       document.getElementById('co_addr').value,
    bank:       document.getElementById('co_bank').value,
    depositor:  document.getElementById('co_depositor').value,
    account:    document.getElementById('co_account').value,
  };
  try{ localStorage.setItem(CO_LS, JSON.stringify(info)); }catch(e){}
}
function initCompanyForm(){
  const info = loadCompanyInfo();
  ['name','ceo','biz','tel','email','addr','bank','depositor','account'].forEach(k=>{
    const el = document.getElementById('co_'+k);
    if(el && info[k]) el.value = info[k];
  });
  const stamp = localStorage.getItem('fns_stamp_v1');
  if(stamp) showStampPreview(stamp);
}
function handleStampDrop(e){
  e.preventDefault();
  document.getElementById('stampDropZone').classList.remove('dragover');
  const file = Array.from(e.dataTransfer.files).find(f=>f.type.startsWith('image/'));
  if(file) readStampFile(file);
}
function handleStampFile(e){ const file=e.target.files[0]; if(file) readStampFile(file); }
function readStampFile(file){
  const reader = new FileReader();
  reader.onload = e=>{
    const data = e.target.result;
    try{ localStorage.setItem('fns_stamp_v1', data); }catch(err){ showToast('⚠️ 파일이 너무 커요 (2MB 이하 권장)'); return; }
    showStampPreview(data);
    showToast('✅ 도장 저장됐어요');
  };
  reader.readAsDataURL(file);
}
function showStampPreview(dataUrl){
  document.getElementById('stampPreviewImg').src = dataUrl;
  document.getElementById('stampPreviewWrap').style.display = 'flex';
}
function removeStamp(){
  localStorage.removeItem('fns_stamp_v1');
  document.getElementById('stampPreviewImg').src = '';
  document.getElementById('stampPreviewWrap').style.display = 'none';
  document.getElementById('stampFileInput').value = '';
  showToast('🗑 도장 삭제됐어요');
}

const VENDOR_LS = 'fns_vendors_v1';
const DEFAULT_VENDORS = [
  {id:1, emoji:'🏭', name:'스텐코리아',    category:'SUS 판재·봉·관 전문',      url:'https://www.stenkorea.com'},
  {id:2, emoji:'🔧', name:'밸브코리아',    category:'산업용 밸브 전문몰',        url:'https://www.valvekorea.com'},
  {id:3, emoji:'📏', name:'계측기닷컴',    category:'압력계·온도계·유량계',      url:'https://www.gmeasure.co.kr'},
  {id:4, emoji:'🔩', name:'스텐마트',      category:'스텐 피팅·페롤·부속',       url:'https://www.stenmart.co.kr'},
  {id:5, emoji:'🛒', name:'인터파크 산업재', category:'공구·부품 종합 쇼핑',     url:'https://biz.interpark.com'},
];

function loadVendors(){
  try{ const s=localStorage.getItem(VENDOR_LS); if(s) return JSON.parse(s); }catch(e){}
  return JSON.parse(JSON.stringify(DEFAULT_VENDORS));
}
function saveVendors(){ try{ localStorage.setItem(VENDOR_LS,JSON.stringify(vendors)); }catch(e){} }
let vendors = loadVendors();
let vendorIdCnt = Math.max(0,...vendors.map(v=>v.id));

function renderVendors(){
  const grid = document.getElementById('vendorGrid');
  if(!grid) return;
  if(!vendors.length){
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:32px 0;color:var(--text3);font-size:13px">사이트를 추가해 주세요 →  오른쪽 상단 <strong>＋ 사이트 추가</strong> 버튼</div>`;
    return;
  }
  grid.innerHTML = vendors.map(v=>`
    <div class="vendor-card">
      <div class="vendor-top">
        <div class="vendor-emoji">${v.emoji||'🏢'}</div>
        <div class="vendor-info">
          <div class="vendor-name" title="${v.name}">${v.name}</div>
          <div class="vendor-category">${v.category||''}</div>
        </div>
      </div>
      <div class="vendor-actions">
        <a class="vendor-link" href="${v.url}" target="_blank" rel="noopener">🔗 사이트 바로가기</a>
        <div style="display:flex;gap:4px">
          <button class="vendor-edit" onclick="openEditVendor(${v.id})" title="수정">✏️</button>
          <button class="vendor-del" onclick="deleteVendor(${v.id})" title="삭제">✕</button>
        </div>
      </div>
    </div>`).join('');
}

function deleteVendor(id){
  vendors = vendors.filter(v=>v.id!==id);
  saveVendors();
  renderVendors();
  showToast('🗑️ 삭제됐어요');
}

// 추가/수정 모달 공용
function openVendorModal(editId = null){
  const v = editId ? vendors.find(v=>v.id===editId) : null;
  const isEdit = !!v;
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'vendorModal';
  overlay.onclick = e=>{ if(e.target===overlay) closeVendorModal(); };
  overlay.innerHTML = `
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-title">${isEdit ? '✏️ 구매처 수정' : '🛒 구매처 사이트 추가'}</div>
      <div class="modal-field">
        <label>이모지 (선택)</label>
        <input id="v_emoji" placeholder="🏭 🔧 🔩 📦 🛒 등" value="${isEdit ? esc(v.emoji||'🏢') : '🏢'}" maxlength="4">
      </div>
      <div class="modal-field">
        <label>사이트 이름 *</label>
        <input id="v_name" placeholder="예) 스텐코리아" value="${isEdit ? esc(v.name) : ''}" autofocus>
      </div>
      <div class="modal-field">
        <label>취급 품목 설명</label>
        <input id="v_cat" placeholder="예) SUS 판재·봉·관 전문" value="${isEdit ? esc(v.category||'') : ''}">
      </div>
      <div class="modal-field">
        <label>URL *</label>
        <input id="v_url" placeholder="https://..." type="url" value="${isEdit ? esc(v.url) : ''}">
      </div>
      <div class="modal-btns">
        <button class="btn btn-ghost" onclick="closeVendorModal()">취소</button>
        <button class="btn btn-primary" onclick="confirmVendorModal(${editId||'null'})">${isEdit ? '저장' : '추가'}</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  setTimeout(()=>{ const el=document.getElementById('v_name'); if(el) el.focus(); },50);
}

function openAddVendor(){ openVendorModal(null); }
function openEditVendor(id){ openVendorModal(id); }

function closeVendorModal(){
  const el = document.getElementById('vendorModal');
  if(el) el.remove();
}

function confirmVendorModal(editId){
  const name = document.getElementById('v_name').value.trim();
  const url  = document.getElementById('v_url').value.trim();
  if(!name){ showToast('⚠️ 사이트 이름을 입력해 주세요'); return; }
  if(!url || !url.startsWith('http')){ showToast('⚠️ URL을 올바르게 입력해 주세요 (https://...)'); return; }
  const emoji    = document.getElementById('v_emoji').value.trim() || '🏢';
  const category = document.getElementById('v_cat').value.trim();
  if(editId){
    const v = vendors.find(v=>v.id===editId);
    if(v){ v.emoji=emoji; v.name=name; v.category=category; v.url=url; }
    showToast(`✅ "${name}" 수정됐어요`);
  } else {
    vendors.push({ id:++vendorIdCnt, emoji, name, category, url });
    showToast(`✅ "${name}" 추가됐어요`);
  }
  saveVendors();
  renderVendors();
  closeVendorModal();
}

function confirmAddVendor(){ confirmVendorModal(null); }

// 초기 실행
try { calcVol(); } catch(e) {}
try { calcReverse(); } catch(e) {}
try { calcAll(); } catch(e) {}
try { renderNav(); } catch(e) {}
try { renderBuja(); } catch(e) {}
try { renderExtra(); } catch(e) {}
try { renderPresets(); } catch(e) {}
try { renderQuickTags(); } catch(e) {}
try { initPreviews(); } catch(e) {}
try { renderVendors(); } catch(e) {}
try { renderPriceHistory(); } catch(e) {}
try { initCompanyForm(); } catch(e) {}
try { renderQuoteNotes(); } catch(e) {}

// ══ PWA Service Worker ══
if('serviceWorker' in navigator){
  const swCode = `
    const CACHE = 'fns-tank-v1';
    const CDN = [
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js',
      'https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap'
    ];
    self.addEventListener('install', e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CDN).catch(()=>{})));
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener('fetch', e=>{
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>new Response('',{status:408}))));
    });
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(()=>{});
}

// ══ 앱 설치 배너 ══
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e=>{
  e.preventDefault();
  deferredPrompt = e;
  showInstallBanner();
});
function showInstallBanner(){
  if(document.getElementById('installBanner')) return;
  const bar = document.createElement('div');
  bar.id = 'installBanner';
  bar.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:#1e3a8a;color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;z-index:300;box-shadow:0 -4px 20px rgba(0,0,0,0.2);';
  bar.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px">
      <span style="font-size:24px">🏭</span>
      <div>
        <div style="font-size:13px;font-weight:700">홈 화면에 설치하기</div>
        <div style="font-size:11px;opacity:0.75;margin-top:2px">앱처럼 바로 실행할 수 있어요</div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button onclick="document.getElementById('installBanner').remove()" style="background:rgba(255,255,255,0.15);border:none;color:#fff;padding:8px 14px;border-radius:8px;font-size:12px;cursor:pointer">나중에</button>
      <button onclick="installPWA()" style="background:#fff;border:none;color:#1e3a8a;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer">설치</button>
    </div>`;
  document.body.appendChild(bar);
}
function installPWA(){
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(()=>{
    deferredPrompt = null;
    const bar = document.getElementById('installBanner');
    if(bar) bar.remove();
  });
}
window.addEventListener('appinstalled', ()=>{
  const bar = document.getElementById('installBanner');
  if(bar) bar.remove();
  showToast('✅ 홈 화면에 설치됐어요!');
});
</script>
</body>
</html>
